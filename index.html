<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="icon" type="image/png" href="favicon.ico">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agregar Pr√©stamo</title>
    <script type="module">
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
  import {
    getFirestore, collection, getDocs, getDoc, setDoc, deleteDoc, updateDoc, doc
  } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

  // ‚úÖ Declaraci√≥n primero
  const firebaseConfig = {
    apiKey: "AIzaSyB1Kj1aza4ynCCLMKObO8_zREB_dnxxL4s",
    authDomain: "prestamos-pregrado.firebaseapp.com",
    projectId: "prestamos-pregrado",
    storageBucket: "prestamos-pregrado.firebasestorage.app",
    messagingSenderId: "760036803136",
  appId: "1:760036803136:web:60ebba863d673c49e515a5"
  };

  // ‚úÖ Uso despu√©s
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  window.buscarUsuario = async function () {
    const documento = document.getElementById("documento").value.trim();
    const ref = doc(db, "usuarios", documento);
    const snap = await getDoc(ref);

    if (snap.exists()) {
      const u = snap.data();
      document.getElementById("nombre").value = u.nombre || "";
      document.getElementById("tipoUsuario").value = u.tipoUsuario || "";
      document.getElementById("facultad").value = u.facultad || "";
    } else {
      document.getElementById("nombre").value = "";
      document.getElementById("tipoUsuario").value = "";
      document.getElementById("facultad").value = "";
    }
  };

window.agregarSalon = function () {
  const contenedor = document.getElementById("salones-container");
  const nuevo = document.createElement("div");
  nuevo.className = "salon-item";
  nuevo.innerHTML = `
    <input type="text" class="salon" placeholder="Sal√≥n (ej: 301P)">
    <label>Hora entrega:</label>
    <input type="time" class="horaEntrega">
    <label>Hora devoluci√≥n:</label>
    <input type="time" class="horaDevolucion">
    <button type="button" onclick="this.parentElement.remove()">‚ùå</button>
  `;
  contenedor.appendChild(nuevo);
};

window.agregarPrestamo = async function () {
  const nombre = document.getElementById("nombre").value;
  const documento = document.getElementById("documento").value;
  let tipoUsuario = document.getElementById("tipoUsuario").value.trim();
  const facultad = document.getElementById("facultad").value;
const salones = [];
document.querySelectorAll("#salones-container .salon-item").forEach(div => {
  const nombreSalon = div.querySelector(".salon").value.trim();
  const horaEntrega = div.querySelector(".horaEntrega").value;
  const horaDevolucion = div.querySelector(".horaDevolucion").value;
  if (nombreSalon && horaEntrega && horaDevolucion) {
    salones.push({ nombre: nombreSalon, horaEntrega, horaDevolucion });
  }
});

if (salones.length === 0) {
  alert("Por favor, agregue al menos un sal√≥n con horario.");
  return;
}

  // üßÆ Leer las cantidades
  const cantidades = document.querySelectorAll(".cantidad-equipo");
  let equipos = [];
  cantidades.forEach(input => {
    const cantidad = parseInt(input.value);
    if (cantidad > 0) {
      equipos.push({ nombre: input.dataset.equipo, cantidad });
    }
  });

  // Campo "otros"
  const otros = document.getElementById("otros").value.trim();
  if (otros) equipos.push({ nombre: otros, cantidad: 1 });

  if (!nombre || !documento || !facultad || !salon || !horaEntrega || !horaDevolucion || equipos.length === 0) {
    alert("Por favor, complete todos los campos y agregue al menos un equipo.");
    return;
  }

  // Validar tipo de usuario
  const tiposValidos = ["administrativo", "docente", "estudiante"];
  const normalizado = tipoUsuario.toLowerCase();
  if (!tiposValidos.includes(normalizado)) {
    alert("‚ö†Ô∏è Tipo de usuario inv√°lido. Solo se permite: Administrativo, Docente o Estudiante.");
    return;
  }
  tipoUsuario = normalizado.charAt(0).toUpperCase() + normalizado.slice(1);

  const fecha = new Date().toLocaleDateString("es-CO");
  const id = `${documento}`;

const prestamo = {
  nombre,
  documento,
  tipoUsuario,
  facultad,
  salones, // üëà nuevo arreglo con varios salones
  equipos,
  devuelto: false,
  fecha
};


  // üî• Guardar pr√©stamo
  await setDoc(doc(db, "prestamos", id), prestamo);

  // üßæ Guardar usuario si no existe o actualizar datos
  const usuarioRef = doc(db, "usuarios", documento);
  const usuarioSnap = await getDoc(usuarioRef);

  if (!usuarioSnap.exists()) {
    await setDoc(usuarioRef, { nombre, documento, tipoUsuario, facultad });
  } else {
    const datosActuales = usuarioSnap.data();
    let cambios = {};
    if (nombre && nombre !== datosActuales.nombre) cambios.nombre = nombre;
    if (tipoUsuario && tipoUsuario !== datosActuales.tipoUsuario) cambios.tipoUsuario = tipoUsuario;
    if (facultad && facultad !== datosActuales.facultad) cambios.facultad = facultad;
    if (Object.keys(cambios).length > 0) await updateDoc(usuarioRef, cambios);
  }

  alert("‚úÖ Pr√©stamo registrado correctamente.");

  // Limpiar formulario
  ["documento", "nombre", "tipoUsuario", "facultad", "salon", "horaEntrega", "horaDevolucion", "otros"].forEach(id => {
    document.getElementById(id).value = "";
  });
  document.querySelectorAll(".cantidad-equipo").forEach(input => input.value = 0);

  if (typeof cargarDatos === "function") cargarDatos();
};


        window.firestore = { db, getFirestore, collection, doc, getDocs, getDoc, setDoc };
      </script>
    <style>
      table {
  width: 100%;
  overflow-x: auto;
  display: block;
}
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
        }

        /* Estilos para pr√©stamos activos y devueltos */
        .prestamo-activo {
            background-color: rgba(255, 255, 0, 0.2); /* Amarillo con baja opacidad */
        }
        .prestamo-devuelto {
            background-color: rgba(0, 255, 0, 0.2); /* Verde con baja opacidad */
        }

        .container {
            max-width: 100%;
            margin: auto;
            background: white;
            width: 100%;
            box-sizing: border-box;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
        }
        input {
            margin: 5px 0;
            padding: 10px;
            width: 98%;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
	select {
            margin: 5px 0;
            padding: 10px;
            width: 94%;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
	button {
            margin: 5px 0;
            padding: 10px;
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        fieldset {
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .checkbox-container {
            display: flex;
            flex-wrap: wrap;
            gap: 80px;
        }
        .checkbox-container label {
            display: flex;
            align-items: center;
            gap: 5px;
            background: #e8e8e8;
            padding: 5px 10px;
            border-radius: 5px;
        }
        .card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            cursor: pointer;
            transition: box-shadow 0.3s ease;
        }
        .card:hover {
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
        }
        .card.expanded {
            background: #f9f9f9;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-body {
            display: none;
            margin-top: 10px;
        }
        .card.expanded .card-body {
            display: block;
        }
        .btn-delete, .btn-edit, .btn-return {
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 5px;
        }
        .btn-delete {
            background: red;
        }
        .btn-return {
            background: green;
        }
        .btn-edit {
            background: orange;
        }
/* Estilos para el men√∫ */
        nav {
            background-color: #007BFF;
            padding: 10px;
            color: white;
        }
        nav ul {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: space-around;
        }
        nav ul li {
            display: inline;
        }
        nav ul li a {
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            display: block;
        }
        nav ul li a:hover {
            background-color: #0056b3;
        }
        @media (max-width: 600px) {
  body {
    font-size: 14px;
  }

  nav ul {
    flex-direction: column;
    align-items: center;
  }

  nav ul li {
    width: 100%;
    text-align: center;
  }

  table, th, td {
    font-size: 12px;
  }

  .card {
    font-size: 14px;
    padding: 8px;
  }
}
@media (max-width: 600px) {
  .card-body button {
    display: block;
    width: 100%;
    margin-bottom: 6px;
  }
}
.checkbox-container label {
  display: flex;
  align-items: center;
  justify-content: space-between;
  width: 250px;
}
.checkbox-container input[type="number"] {
  width: 60px;
  padding: 5px;
  text-align: center;
}
.salon-item {
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 6px;
}
.salon-item input[type="text"] {
  width: 120px;
}
.salon-item input[type="time"] {
  width: 110px;
}
.salon-item button {
  background: red;
  color: white;
  border: none;
  border-radius: 5px;
  padding: 5px 8px;
  cursor: pointer;
}

    </style>
</head>
<body onload="cargarDatos()">
<!-- Men√∫ de navegaci√≥n -->
 <script>
  const claveCorrecta = "Chapi2025";
  const claveGuardada = sessionStorage.getItem("clavePrestamos");

  if (claveGuardada !== claveCorrecta) {
    const intento = prompt("üîê Ingresa la contrase√±a de acceso:");
    if (intento === claveCorrecta) {
      sessionStorage.setItem("clavePrestamos", claveCorrecta);
    } else {
      alert("Contrase√±a incorrecta.");
      window.location.href = "https://google.com";
    }
  }
</script>

    <nav>
        <ul>
            <li><a href="index.html" onclick="cargarSeccion('gestion')">Gesti√≥n de pr√©stamos</a></li>
            <li><a href="activos.html" onclick="cargarSeccion('activos')">Pr√©stamos activos</a></li>
            <li><a href="historial.html" onclick="cargarSeccion('historial')">Historial</a></li>
            <li><a href="estadisticas.html" onclick="cargarSeccion('estadisticas')">Estad√≠sticas</a></li>
        </ul>
    </nav>
    <div class="container">
        <h2>Gesti√≥n de Pr√©stamos</h2>

         <div id="listaPrestamos"></div>
         
        <!-- Lista de pr√©stamos en tarjetas (arriba del formulario) -->
        <h2>Agregar Pr√©stamo</h2>
        

        <!-- Formulario de pr√©stamos -->
        <input type="text" id="documento" placeholder="N√∫mero de documento" onblur="buscarUsuario()">
        <input type="text" id="nombre" placeholder="Nombre de la persona">
        <input type="text" id="tipoUsuario" placeholder="Tipo de usuario (Docente, Administrativo, Estudiante, etc.)">
        <input type="text" id="facultad" placeholder="Facultad">

<fieldset>
  <legend>Salones y Horarios</legend>
  <div id="salones-container">
    <div class="salon-item">
      <input type="text" class="salon" placeholder="Sal√≥n (ej: 301P)">
      <label>Hora entrega:</label>
      <input type="time" class="horaEntrega">
      <label>Hora devoluci√≥n:</label>
      <input type="time" class="horaDevolucion">
    </div>
  </div>
  <button type="button" onclick="agregarSalon()">+ Agregar otro sal√≥n</button>
</fieldset>
       
        <fieldset>
          <legend>Equipo Prestado</legend>
          <div class="checkbox-container">
            <label>
              HDMI (TV)
              <input type="number" min="0" value="0" class="cantidad-equipo" data-equipo="HDMI (TV)">
            </label>
            <label>
              HDMI (ONESCREEN)
              <input type="number" min="0" value="0" class="cantidad-equipo" data-equipo="HDMI (ONESCREEN)">
            </label>
            <label>
              CONTROL (Videobeam)
              <input type="number" min="0" value="0" class="cantidad-equipo" data-equipo="CONTROL VB">
            </label>
            <label>
              HDMI (Videobeam)
              <input type="number" min="0" value="0" class="cantidad-equipo" data-equipo="HDMI (VIDEOBEAM)">
            </label>
            <label>
              PORT√ÅTIL LENOVO
              <input type="number" min="0" value="0" class="cantidad-equipo" data-equipo="PORTATIL LENOVO">
            </label>
            <label>
              ANCHOR
              <input type="number" min="0" value="0" class="cantidad-equipo" data-equipo="ANCHOR">
            </label>
          </div>
          <input type="text" id="otros" placeholder="Otros equipos">
        </fieldset>

        
        <button onclick="agregarPrestamo()">Agregar</button>
 

    </div>

    <script>
        


        // Funci√≥n para calcular las horas netas de uso
        async function calcularHorasNetas(horaEntrega, horaDevolucion) {
            let entrega = new Date(`1970-01-01T${horaEntrega}:00`);
            let devolucion = new Date(`1970-01-01T${horaDevolucion}:00`);
            let diferencia = devolucion - entrega; // Diferencia en milisegundos
            return Math.floor(diferencia / (1000 * 60 * 60)); // Convertir a horas
        }

        async function agregarAlHistorial(prestamo) {
  const id = `${prestamo.documento}_${prestamo.fecha}`;
  await setDoc(doc(db, "historial", id), prestamo);
}

        const usuarios = [
            {"documento": "123456", "nombre": "Juan P√©rez", "tipoUsuario": "Docente", "facultad": "Ingenier√≠a"},
            {"documento": "654321", "nombre": "Mar√≠a L√≥pez", "tipoUsuario": "Estudiante", "facultad": "Administraci√≥n"},
            {"documento": "111222", "nombre": "Carlos Ram√≠rez", "tipoUsuario": "Administrativo", "facultad": "Derecho"},
	    
   
        ];

        window.buscarUsuario = async function() {
  const documento = document.getElementById("documento").value.trim();
  const snap = await getDoc(doc(db, "usuarios", documento));
  if (snap.exists()) {
    const u = snap.data();
    document.getElementById("nombre").value = u.nombre || "";
    document.getElementById("tipoUsuario").value = u.tipoUsuario || "";
    document.getElementById("facultad").value = u.facultad || "";
  } else {
    document.getElementById("nombre").value = "";
    document.getElementById("tipoUsuario").value = "";
    document.getElementById("facultad").value = "";
  }
}




    // Guardar el usuario en la lista de usuarios si no existe
    async function guardarUsuarioSiNoExiste(documento, datos) {
      
  const usuarioSnap = await firestore.getDoc(firestore.doc(firestore.db, "usuarios", documento));
  if (!usuarioSnap.exists()) {
    await firestore.setDoc(firestore.doc(firestore.db, "usuarios", documento), datos);
  }


    
}

async function cargarDatos() {
  const contenedor = document.getElementById("listaPrestamos");
  if (!contenedor) return; // üö´ Evita el error si el div no existe

  contenedor.innerHTML = "";
  const snapshot = await getDocs(collection(db, "prestamos"));
  const prestamos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

  prestamos.forEach((prestamo) => {
    const card = document.createElement("div");
    card.className = "card";

    if (prestamo.devuelto) {
      card.classList.add("prestamo-devuelto");
    } else {
      card.classList.add("prestamo-activo");
    }

    card.innerHTML = `
      <div class="card-header">
        <span>${prestamo.nombre} - ${prestamo.documento}</span>
        <span>${prestamo.devuelto ? "Devuelto" : "En pr√©stamo"}</span>
      </div>
      <div class="card-body">
        <p><strong>Tipo de Usuario:</strong> ${prestamo.tipoUsuario}</p>
        <p><strong>Facultad:</strong> ${prestamo.facultad}</p>
<p><strong>Salones:</strong> ${
  Array.isArray(prestamo.salones)
    ? prestamo.salones.map(s => `${s.nombre} (${s.horaEntrega} ‚Üí ${s.horaDevolucion})`).join(", ")
    : prestamo.salon || "No registrado"
}</p>

<p><strong>Equipos:</strong> ${
  Array.isArray(prestamo.equipos)
    ? prestamo.equipos.map(e => {
        if (!e) return "";
        // Si es texto antiguo
        if (typeof e === "string") return e;

        // Si es objeto nuevo con nombre y cantidad (sin importar el orden)
        const nombre = e.nombre || e.equipo || "Desconocido";
        const cantidad = e.cantidad || 1;

        return `${nombre} (x${cantidad})`;
      }).join(", ")
    : "Sin datos"
}</p>


        <button class="btn-edit" onclick="editarPrestamo('${prestamo.id}')">Editar</button>
        <button class="btn-return" onclick="marcarDevuelto('${prestamo.id}')">Devolver</button>
        <button class="btn-delete" onclick="eliminarPrestamo('${prestamo.id}')">Eliminar</button>
      </div>
    `;

    card.addEventListener("click", () => {
      card.classList.toggle("expanded");
    });

    listaPrestamos.appendChild(card);
  });
}

async function marcarDevuelto(id) {
  const ref = doc(db, "prestamos", id);
  await updateDoc(ref, { devuelto: true });
  cargarDatos(); // Recarga tarjetas
}

        // Funci√≥n para editar un pr√©stamo
        async function editarPrestamo(id) {
  const ref = doc(db, "prestamos", id);
  const snap = await getDoc(ref);

  if (!snap.exists()) {
    alert("El pr√©stamo no existe.");
    return;
  }

  const prestamo = snap.data();

  // Llenar el formulario
  document.getElementById("documento").value = prestamo.documento;
  document.getElementById("nombre").value = prestamo.nombre;
  document.getElementById("tipoUsuario").value = prestamo.tipoUsuario;
  document.getElementById("facultad").value = prestamo.facultad;
  document.getElementById("salon").value = prestamo.salon;
  document.getElementById("horaEntrega").value = prestamo.horaEntrega;
  document.getElementById("horaDevolucion").value = prestamo.horaDevolucion;

  // Checkboxes
  const checkboxes = document.querySelectorAll("input[type='checkbox']");
  checkboxes.forEach(cb => {
    cb.checked = prestamo.equipos.includes(cb.value);
  });

  // Eliminar de Firestore para que se re-agregue corregido
  await deleteDoc(ref);
  cargarDatos(); // Refrescar vista
}

async function eliminarPrestamo(id) {
  const ref = doc(db, "prestamos", id);
  const snap = await getDoc(ref);
  if (!snap.exists()) return;

  const prestamoEliminado = snap.data();
  await deleteDoc(ref);

  // Calcular horas netas
  const horasNetas = parseFloat(calcularHorasNetas(prestamoEliminado.horaEntrega, prestamoEliminado.horaDevolucion));
  const tipo = prestamoEliminado.tipoUsuario.toLowerCase();
  const horaEntrega = parseInt(prestamoEliminado.horaEntrega.split(":")[0]);
  const fechaHoy = new Date().toLocaleDateString("es-CO");

  // Historial
  await setDoc(doc(db, "historial", id), {
    ...prestamoEliminado,
    fecha: fechaHoy
  });

  // Obtener estad√≠sticas actuales
  const estadRef = doc(db, "estadisticas", "resumen");
  const estadSnap = await getDocAgain(estadRef);
  const estadisticas = estadSnap.exists() ? estadSnap.data() : {
    docentes: { ma√±ana: 0, tarde: 0, horasHDMI: 0, horasPortatiles: 0, horasAnchors: 0 },
    estudiantes: { ma√±ana: 0, tarde: 0, horasHDMI: 0, horasPortatiles: 0, horasAnchors: 0 },
    administrativos: { ma√±ana: 0, tarde: 0, horasHDMI: 0, horasPortatiles: 0, horasAnchors: 0 }
  };

  const cat = estadisticas[tipo];
  if (!cat) return;

  if (horaEntrega < 12) cat.ma√±ana++;
  else cat.tarde++;

      if (prestamoEliminado.equipos.includes("HDMI (TV)")) cat.horasHDMITV += horasNetas;
      if (prestamoEliminado.equipos.includes("HDMI (ONESCREEN)")) cat.horasHDMIOneScreen += horasNetas;
      if (prestamoEliminado.equipos.includes("CONTROL VB")) cat.horasVB += horasNetas;
      if (prestamoEliminado.equipos.some(e => e.includes("PORTATIL"))) cat.horasPortatiles += horasNetas;
      if (prestamoEliminado.equipos.includes("ANCHOR")) cat.horasAnchors += horasNetas;


  await setDoc(estadRef, estadisticas);
  cargarDatos();

  console.log("Pr√©stamo eliminado y guardado en historial:", prestamoEliminado);
  console.log("Estad√≠sticas actualizadas:", estadisticas);
}
    </script>
    <b> ¬© Juan Ladino - 2025 </b>
</body>
</html>