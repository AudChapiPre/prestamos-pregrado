<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="icon" type="image/png" href="favicon.ico">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agregar Pr√©stamo</title>
    <script type="module">
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
  import {
    getFirestore, collection, getDocs, getDoc, setDoc, deleteDoc, updateDoc, doc
  } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

  // ‚úÖ Declaraci√≥n primero
  const firebaseConfig = {
    apiKey: "AIzaSyC7llIg5wLu8P_5WBbjg4GW3orZZ1w8_vE",
    authDomain: "prestamos-1efef.firebaseapp.com",
    projectId: "prestamos-1efef",
    storageBucket: "prestamos-1efef.firebasestorage.app",
    messagingSenderId: "977813237082",
    appId: "1:977813237082:web:576287c13c305db3811763"
  };

  // ‚úÖ Uso despu√©s
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  window.buscarUsuario = async function () {
    const documento = document.getElementById("documento").value.trim();
    const ref = doc(db, "usuarios", documento);
    const snap = await getDoc(ref);

    if (snap.exists()) {
      const u = snap.data();
      document.getElementById("nombre").value = u.nombre || "";
      document.getElementById("tipoUsuario").value = u.tipoUsuario || "";
      document.getElementById("facultad").value = u.facultad || "";
    } else {
      document.getElementById("nombre").value = "";
      document.getElementById("tipoUsuario").value = "";
      document.getElementById("facultad").value = "";
    }
  };

  window.agregarPrestamo = async function () {
  const nombre = document.getElementById("nombre").value;
  const documento = document.getElementById("documento").value;
  const tipoUsuario = document.getElementById("tipoUsuario").value;
  const facultad = document.getElementById("facultad").value;
  const salon = document.getElementById("salon").value;
  const horaEntrega = document.getElementById("horaEntrega").value;
  const horaDevolucion = document.getElementById("horaDevolucion").value;
  

  const checkboxes = document.querySelectorAll("input[type='checkbox']:checked");
  let equipos = Array.from(checkboxes).map(cb => cb.value);
  const otros = document.getElementById("otros").value.trim();
  if (otros) equipos.push(otros);

  if (!nombre || !documento || !facultad || !salon || !horaEntrega || !horaDevolucion || equipos.length === 0) {
    alert("Por favor, complete todos los campos.");
    return;
  }

  const fecha = new Date().toLocaleDateString("es-CO");
  const id = `${documento}`;

  const prestamo = {
    nombre,
    documento,
    tipoUsuario,
    facultad,
    salon,
    horaEntrega,
    horaDevolucion,
    equipos,
    devuelto: false,
    fecha
  };



  // ‚úÖ Guardar pr√©stamo en Firestore
  await setDoc(doc(db, "prestamos", id), prestamo);

  // ‚úÖ Guardar usuario si no existe a√∫n
  const usuarioRef = doc(db, "usuarios", documento);
  const usuarioSnap = await getDoc(usuarioRef);
  if (!usuarioSnap.exists()) {
    await setDoc(usuarioRef, { nombre, documento, tipoUsuario, facultad });
  }

  alert("Pr√©stamo registrado correctamente.");
  // Limpiar formulario
document.getElementById("documento").value = "";
document.getElementById("nombre").value = "";
document.getElementById("tipoUsuario").value = "";
document.getElementById("facultad").value = "";
document.getElementById("salon").value = "";
document.getElementById("horaEntrega").value = "";
document.getElementById("horaDevolucion").value = "";
document.getElementById("otros").value = "";

// Limpiar todos los checkboxes
document.querySelectorAll("input[type='checkbox']").forEach(cb => cb.checked = false);

// Recargar vista si quieres actualizar lista
if (typeof cargarDatos === "function") cargarDatos();
}

        window.firestore = { db, getFirestore, collection, doc, getDocs, getDoc, setDoc };
      </script>
    <style>
      table {
  width: 100%;
  overflow-x: auto;
  display: block;
}
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
        }

        /* Estilos para pr√©stamos activos y devueltos */
        .prestamo-activo {
            background-color: rgba(255, 255, 0, 0.2); /* Amarillo con baja opacidad */
        }
        .prestamo-devuelto {
            background-color: rgba(0, 255, 0, 0.2); /* Verde con baja opacidad */
        }

        .container {
            max-width: 100%;
            margin: auto;
            background: white;
            width: 100%;
            box-sizing: border-box;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
        }
        input {
            margin: 5px 0;
            padding: 10px;
            width: 98%;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
	select {
            margin: 5px 0;
            padding: 10px;
            width: 94%;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
	button {
            margin: 5px 0;
            padding: 10px;
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        fieldset {
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .checkbox-container {
            display: flex;
            flex-wrap: wrap;
            gap: 80px;
        }
        .checkbox-container label {
            display: flex;
            align-items: center;
            gap: 5px;
            background: #e8e8e8;
            padding: 5px 10px;
            border-radius: 5px;
        }
        .card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            cursor: pointer;
            transition: box-shadow 0.3s ease;
        }
        .card:hover {
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
        }
        .card.expanded {
            background: #f9f9f9;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-body {
            display: none;
            margin-top: 10px;
        }
        .card.expanded .card-body {
            display: block;
        }
        .btn-delete, .btn-edit, .btn-return {
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 5px;
        }
        .btn-delete {
            background: red;
        }
        .btn-return {
            background: green;
        }
        .btn-edit {
            background: orange;
        }
/* Estilos para el men√∫ */
        nav {
            background-color: #007BFF;
            padding: 10px;
            color: white;
        }
        nav ul {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: space-around;
        }
        nav ul li {
            display: inline;
        }
        nav ul li a {
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            display: block;
        }
        nav ul li a:hover {
            background-color: #0056b3;
        }
        @media (max-width: 600px) {
  body {
    font-size: 14px;
  }

  nav ul {
    flex-direction: column;
    align-items: center;
  }

  nav ul li {
    width: 100%;
    text-align: center;
  }

  table, th, td {
    font-size: 12px;
  }

  .card {
    font-size: 14px;
    padding: 8px;
  }
}
@media (max-width: 600px) {
  .card-body button {
    display: block;
    width: 100%;
    margin-bottom: 6px;
  }
}
    </style>
</head>
<body onload="cargarDatos()">
<!-- Men√∫ de navegaci√≥n -->
 <script>
  const claveCorrecta = "12345Post";
  const claveGuardada = sessionStorage.getItem("clavePrestamos");

  if (claveGuardada !== claveCorrecta) {
    const intento = prompt("üîê Ingresa la contrase√±a de acceso:");
    if (intento === claveCorrecta) {
      sessionStorage.setItem("clavePrestamos", claveCorrecta);
    } else {
      alert("Contrase√±a incorrecta.");
      window.location.href = "https://google.com";
    }
  }
</script>

    <nav>
        <ul>
            <li><a href="index.html" onclick="cargarSeccion('gestion')">Gesti√≥n de pr√©stamos</a></li>
            <li><a href="activos.html" onclick="cargarSeccion('activos')">Pr√©stamos activos</a></li>
            <li><a href="historial.html" onclick="cargarSeccion('historial')">Historial</a></li>
            <li><a href="estadisticas.html" onclick="cargarSeccion('estadisticas')">Estad√≠sticas</a></li>
        </ul>
    </nav>
    <div class="container">
        <h2>Gesti√≥n de Pr√©stamos</h2>

        <!-- Lista de pr√©stamos en tarjetas (arriba del formulario) -->
        <h2>Agregar Pr√©stamo</h2>
        

        <!-- Formulario de pr√©stamos -->
        <input type="text" id="documento" placeholder="N√∫mero de documento" onblur="buscarUsuario()">
        <input type="text" id="nombre" placeholder="Nombre de la persona">
        <input type="text" id="tipoUsuario" placeholder="Tipo de usuario (Docente, Administrativo, Estudiante, etc.)">
        <input type="text" id="facultad" placeholder="Facultad">
        <input type="text" id="salon" placeholder="Sal√≥n de uso">
        <input type="time" id="horaEntrega" placeholder="Hora de entrega">
        <input type="time" id="horaDevolucion" placeholder="Hora estimada de devoluci√≥n">
        
        <fieldset>
            <legend>Equipo Prestado</legend>
            <div class="checkbox-container">
                <label><input type="checkbox" value="HDMI"> HDMI</label>
                <label><input type="checkbox" value="CONTROL VB"> CONTROL VB</label>
                <label><input type="checkbox" value="PORTATIL LENOVO"> PORTATIL LENOVO</label>
                <label><input type="checkbox" value="PORTATIL DELL"> PORTATIL DELL</label>
                <label><input type="checkbox" value="CARGADOR"> CARGADOR</label>
                <label><input type="checkbox" value="ANCHOR"> ANCHOR</label>
            </div>
            <input type="text" id="otros" placeholder="Otros equipos">
        </fieldset>
        
        <button onclick="agregarPrestamo()">Agregar</button>
 

    </div>

    <script>
        


        // Funci√≥n para calcular las horas netas de uso
        async function calcularHorasNetas(horaEntrega, horaDevolucion) {
            let entrega = new Date(`1970-01-01T${horaEntrega}:00`);
            let devolucion = new Date(`1970-01-01T${horaDevolucion}:00`);
            let diferencia = devolucion - entrega; // Diferencia en milisegundos
            return Math.floor(diferencia / (1000 * 60 * 60)); // Convertir a horas
        }

        async function agregarAlHistorial(prestamo) {
  const id = `${prestamo.documento}_${prestamo.fecha}`;
  await setDoc(doc(db, "historial", id), prestamo);
}

        const usuarios = [
            {"documento": "123456", "nombre": "Juan P√©rez", "tipoUsuario": "Docente", "facultad": "Ingenier√≠a"},
            {"documento": "654321", "nombre": "Mar√≠a L√≥pez", "tipoUsuario": "Estudiante", "facultad": "Administraci√≥n"},
            {"documento": "111222", "nombre": "Carlos Ram√≠rez", "tipoUsuario": "Administrativo", "facultad": "Derecho"},
	    
   
        ];

        window.buscarUsuario = async function() {
  const documento = document.getElementById("documento").value.trim();
  const snap = await getDoc(doc(db, "usuarios", documento));
  if (snap.exists()) {
    const u = snap.data();
    document.getElementById("nombre").value = u.nombre || "";
    document.getElementById("tipoUsuario").value = u.tipoUsuario || "";
    document.getElementById("facultad").value = u.facultad || "";
  } else {
    document.getElementById("nombre").value = "";
    document.getElementById("tipoUsuario").value = "";
    document.getElementById("facultad").value = "";
  }
}




    // Guardar el usuario en la lista de usuarios si no existe
    async function guardarUsuarioSiNoExiste(documento, datos) {
      
  const usuarioSnap = await firestore.getDoc(firestore.doc(firestore.db, "usuarios", documento));
  if (!usuarioSnap.exists()) {
    await firestore.setDoc(firestore.doc(firestore.db, "usuarios", documento), datos);
  }


    
}

async function cargarDatos() {
  const contenedor = document.getElementById("listaPrestamos");
  if (!contenedor) return; // üö´ Evita el error si el div no existe

  contenedor.innerHTML = "";
  const snapshot = await getDocs(collection(db, "prestamos"));
  const prestamos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

  prestamos.forEach((prestamo) => {
    const card = document.createElement("div");
    card.className = "card";

    if (prestamo.devuelto) {
      card.classList.add("prestamo-devuelto");
    } else {
      card.classList.add("prestamo-activo");
    }

    card.innerHTML = `
      <div class="card-header">
        <span>${prestamo.nombre} - ${prestamo.documento}</span>
        <span>${prestamo.devuelto ? "Devuelto" : "En pr√©stamo"}</span>
      </div>
      <div class="card-body">
        <p><strong>Tipo de Usuario:</strong> ${prestamo.tipoUsuario}</p>
        <p><strong>Facultad:</strong> ${prestamo.facultad}</p>
        <p><strong>Sal√≥n:</strong> ${prestamo.salon}</p>
        <p><strong>Hora Entrega:</strong> ${prestamo.horaEntrega}</p>
        <p><strong>Hora Devoluci√≥n:</strong> ${prestamo.horaDevolucion}</p>
        <p><strong>Equipos:</strong> ${prestamo.equipos?.join(", ")}</p>
        <button class="btn-edit" onclick="editarPrestamo('${prestamo.id}')">Editar</button>
        <button class="btn-return" onclick="marcarDevuelto('${prestamo.id}')">Devolver</button>
        <button class="btn-delete" onclick="eliminarPrestamo('${prestamo.id}')">Eliminar</button>
      </div>
    `;

    card.addEventListener("click", () => {
      card.classList.toggle("expanded");
    });

    listaPrestamos.appendChild(card);
  });
}

async function marcarDevuelto(id) {
  const ref = doc(db, "prestamos", id);
  await updateDoc(ref, { devuelto: true });
  cargarDatos(); // Recarga tarjetas
}

        // Funci√≥n para editar un pr√©stamo
        async function editarPrestamo(id) {
  const ref = doc(db, "prestamos", id);
  const snap = await getDoc(ref);

  if (!snap.exists()) {
    alert("El pr√©stamo no existe.");
    return;
  }

  const prestamo = snap.data();

  // Llenar el formulario
  document.getElementById("documento").value = prestamo.documento;
  document.getElementById("nombre").value = prestamo.nombre;
  document.getElementById("tipoUsuario").value = prestamo.tipoUsuario;
  document.getElementById("facultad").value = prestamo.facultad;
  document.getElementById("salon").value = prestamo.salon;
  document.getElementById("horaEntrega").value = prestamo.horaEntrega;
  document.getElementById("horaDevolucion").value = prestamo.horaDevolucion;

  // Checkboxes
  const checkboxes = document.querySelectorAll("input[type='checkbox']");
  checkboxes.forEach(cb => {
    cb.checked = prestamo.equipos.includes(cb.value);
  });

  // Eliminar de Firestore para que se re-agregue corregido
  await deleteDoc(ref);
  cargarDatos(); // Refrescar vista
}

async function eliminarPrestamo(id) {
  const ref = doc(db, "prestamos", id);
  const snap = await getDoc(ref);
  if (!snap.exists()) return;

  const prestamoEliminado = snap.data();
  await deleteDoc(ref);

  // Calcular horas netas
  const horasNetas = parseFloat(calcularHorasNetas(prestamoEliminado.horaEntrega, prestamoEliminado.horaDevolucion));
  const tipo = prestamoEliminado.tipoUsuario.toLowerCase();
  const horaEntrega = parseInt(prestamoEliminado.horaEntrega.split(":")[0]);
  const fechaHoy = new Date().toLocaleDateString("es-CO");

  // Historial
  await setDoc(doc(db, "historial", id), {
    ...prestamoEliminado,
    fecha: fechaHoy
  });

  // Obtener estad√≠sticas actuales
  const estadRef = doc(db, "estadisticas", "resumen");
  const estadSnap = await getDocAgain(estadRef);
  const estadisticas = estadSnap.exists() ? estadSnap.data() : {
    docentes: { ma√±ana: 0, tarde: 0, horasHDMI: 0, horasPortatiles: 0, horasAnchors: 0 },
    estudiantes: { ma√±ana: 0, tarde: 0, horasHDMI: 0, horasPortatiles: 0, horasAnchors: 0 },
    administrativos: { ma√±ana: 0, tarde: 0, horasHDMI: 0, horasPortatiles: 0, horasAnchors: 0 }
  };

  const cat = estadisticas[tipo];
  if (!cat) return;

  if (horaEntrega < 12) cat.ma√±ana++;
  else cat.tarde++;

  if (prestamoEliminado.equipos.includes("HDMI")) cat.horasHDMI += horasNetas;
  if (prestamoEliminado.equipos.includes("PORTATIL LENOVO") || prestamoEliminado.equipos.includes("PORTATIL DELL")) cat.horasPortatiles += horasNetas;
  if (prestamoEliminado.equipos.includes("ANCHOR")) cat.horasAnchors += horasNetas;

  await setDoc(estadRef, estadisticas);
  cargarDatos();

  console.log("Pr√©stamo eliminado y guardado en historial:", prestamoEliminado);
  console.log("Estad√≠sticas actualizadas:", estadisticas);
}
    </script>
    <b> ¬© Juan Ladino - 2025 </b>
</body>
</html>