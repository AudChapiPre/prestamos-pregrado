<!DOCTYPE html>
<html lang="es">
<head>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<link rel="icon" type="image/png" href="favicon.ico">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historial de Pr√©stamos</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import {
          getFirestore,
          getDocs,
          collection, 
          addDoc
        } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
        
        // Configuraci√≥n Firebase
        const firebaseConfig = {
    apiKey: "AIzaSyB1Kj1aza4ynCCLMKObO8_zREB_dnxxL4s",
    authDomain: "prestamos-pregrado.firebaseapp.com",
    projectId: "prestamos-pregrado",
    storageBucket: "prestamos-pregrado.firebasestorage.app",
    messagingSenderId: "760036803136",
  appId: "1:760036803136:web:60ebba863d673c49e515a5"
  };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        import { deleteDoc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

window.borrarHistorialFirestore = async function () {
  if (!confirm("¬øEst√°s seguro de que deseas borrar TODO el historial de Firestore? Esta acci√≥n no se puede deshacer.")) return;

  const snapshot = await getDocs(collection(db, "historial"));
  let borrados = 0;

  for (const docu of snapshot.docs) {
    await deleteDoc(docu.ref);
    borrados++;
  }

  alert(`Historial borrado: ${borrados} registros eliminados.`);
  cargarHistorial();
};



       


        // Leer historial desde Firestore
async function cargarHistorial() {
  const tabla = document.getElementById("historialPrestamos");
  tabla.innerHTML = "";

  const snapshot = await getDocs(collection(db, "historial"));
  const prestamos = [];

  snapshot.forEach(doc => prestamos.push(doc.data()));
  prestamos.reverse();

  prestamos.forEach(p => {
    // üß© Compatibilidad con formato nuevo
    const salones = Array.isArray(p.salones)
      ? p.salones.map(s => s.nombre || "Sin nombre").join(" / ")
      : (p.salon || "N/A");

    const horaEntrega = Array.isArray(p.salones)
      ? p.salones.map(s => s.horaEntrega || "?").join(", ")
      : (p.horaEntrega || "N/A");

    const horaDevolucion = Array.isArray(p.salones)
      ? p.salones.map(s => s.horaDevolucion || "?").join(", ")
      : (p.horaDevolucion || "N/A");

    // üíª Equipos
    const equipos = Array.isArray(p.equipos)
      ? p.equipos.map(e => {
          if (typeof e === "string") return e;
          const nombre = e?.nombre || e?.equipo || "Desconocido";
          const cantidad = e?.cantidad || 1;
          return `${nombre} (x${cantidad})`;
        }).join(" - ")
      : "N/A";

// üïí Sumar horas netas de todos los salones
// üßÆ Calcular horas netas reales, sumando todos los salones si los hay
let horasNetas = 0;

if (Array.isArray(p.salones) && p.salones.length > 0) {
  p.salones.forEach(salon => {
    const h = calcularHorasNetas(salon.horaEntrega, salon.horaDevolucion);
    if (!isNaN(h) && h > 0) horasNetas += h;
  });
} else if (p.horaEntrega && p.horaDevolucion) {
  const h = calcularHorasNetas(p.horaEntrega, p.horaDevolucion);
  if (!isNaN(h) && h > 0) horasNetas = h;
}

// Guardar resultado en el pr√©stamo (por si lo usas despu√©s)
p.horasNetas = horasNetas;


const row = `
  <tr>
    <td>${p.fecha || "N/A"}</td>
    <td>${p.nombre || "N/A"}</td>
    <td>${p.documento || "N/A"}</td>
    <td>${p.tipoUsuario || "N/A"}</td>
    <td>${p.facultad || "N/A"}</td>
    <td>${Array.isArray(p.salones) ? p.salones.map(s => s.nombre || "Sin nombre").join(" / ") : (p.salon || "N/A")}</td>
    <td>${Array.isArray(p.salones) ? p.salones.map(s => s.horaEntrega || "?").join(", ") : (p.horaEntrega || "N/A")}</td>
    <td>${Array.isArray(p.salones) ? p.salones.map(s => s.horaDevolucion || "?").join(", ") : (p.horaDevolucion || "N/A")}</td>
    <td>${Array.isArray(p.equipos) ? p.equipos.map(e => (typeof e === "string" ? e : (e.nombre || e.equipo || "Desconocido")) + (e.cantidad ? ` (x${e.cantidad})` : "")).join(" - ") : "N/A"}</td>
    <td>${Number(horasNetas || 0).toFixed(2)}</td>
  </tr>`;
tabla.innerHTML += row;

  });

  window.historialFire = prestamos;
}

        
        window.filtrarHistorial = function () {
          let filtro = document.getElementById("busqueda").value.toLowerCase();
          let filas = document.querySelectorAll("#historialPrestamos tr");
          filas.forEach(fila => {
            let textoFila = fila.innerText.toLowerCase();
            fila.style.display = textoFila.includes(filtro) ? "" : "none";
          });
        };
        

//EXPORTAR HISTORIAL

window.exportarHistorial = function () {
  const historial = window.historialFire || [];
  if (historial.length === 0) {
    alert("No hay datos para exportar.");
    return;
  }

  const rows = [[
    "Fecha", "Nombre", "Documento", "Tipo de Usuario", "Facultad",
    "Salones", "Hora Entrega", "Hora Devoluci√≥n", "Equipos", "Horas Netas"
  ]];

  historial.forEach(p => {
    const salones = Array.isArray(p.salones)
      ? p.salones.map(s => s.nombre || "Sin nombre").join(" / ")
      : (p.salon || "N/A");

    const horaEntrega = Array.isArray(p.salones)
      ? p.salones.map(s => s.horaEntrega || "?").join(", ")
      : (p.horaEntrega || "N/A");

    const horaDevolucion = Array.isArray(p.salones)
      ? p.salones.map(s => s.horaDevolucion || "?").join(", ")
      : (p.horaDevolucion || "N/A");

    const equipos = Array.isArray(p.equipos)
      ? p.equipos.map(e => {
          if (typeof e === "string") return e;
          const nombre = e?.nombre || e?.equipo || "Desconocido";
          const cantidad = e?.cantidad || 1;
          return `${nombre} (x${cantidad})`;
        }).join(" - ")
      : "N/A";

    // üïí Sumar horas netas de todos los salones
    let horasNetas = 0;
    if (Array.isArray(p.salones)) {
      p.salones.forEach(s => {
        const h = calcularHorasNetas(s.horaEntrega, s.horaDevolucion);
        if (!isNaN(h)) horasNetas += h;
      });
    } else {
      const h = calcularHorasNetas(p.horaEntrega, p.horaDevolucion);
      if (!isNaN(h)) horasNetas += h;
    }

    rows.push([
      p.fecha || "N/A",
      p.nombre || "N/A",
      p.documento || "N/A",
      p.tipoUsuario || "N/A",
      p.facultad || "N/A",
      salones,
      horaEntrega,
      horaDevolucion,
      equipos,
      Number(horasNetas || 0).toFixed(2)
    ]);
  });

  const ws = XLSX.utils.aoa_to_sheet(rows);

  const headerCells = ["A1","B1","C1","D1","E1","F1","G1","H1","I1","J1"];
  headerCells.forEach(cell => {
    if (ws[cell]) {
      ws[cell].s = {
        font: { name: "Calibri", sz: 12, bold: true, color: { rgb: "FFFFFF" } },
        fill: { patternType: "solid", fgColor: { rgb: "007BFF" } },
        alignment: { horizontal: "center", vertical: "center" }
      };
    }
  });

  ws["!cols"] = [
    { wch: 12 }, { wch: 40 }, { wch: 15 }, { wch: 18 }, { wch: 35 },
    { wch: 25 }, { wch: 20 }, { wch: 20 }, { wch: 40 }, { wch: 12 }
  ];

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Historial");
  XLSX.writeFile(wb, "Historial_Prestamos.xlsx");

  alert("‚úÖ Historial exportado correctamente.");
};




        window.onload = cargarHistorial;
        </script>
    <style>
        table {
  width: 100%;
  overflow-x: auto;
  display: block;
}
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
        }
       .container {
            max-width: 100%;
            margin: auto;
            background: white;
            width: 100%;
            box-sizing: border-box;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
        }
        input {
            margin: 5px 0;
            padding: 10px;
            width: 98%;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
	select {
            margin: 5px 0;
            padding: 10px;
            width: 94%;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
	button {
            margin: 5px 0;
            padding: 10px;
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }
        th {
            background: #007BFF;
            color: white;
        }
/* Estilos para el men√∫ */
        nav {
            background-color: #007BFF;
            padding: 10px;
            color: white;
        }
        nav ul {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: space-around;
        }
        nav ul li {
            display: inline;
        }
        nav ul li a {
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            display: block;
        }
        nav ul li a:hover {
            background-color: #0056b3;
        }
        @media (max-width: 600px) {
  body {
    font-size: 14px;
  }

  nav ul {
    flex-direction: column;
    align-items: center;
  }

  nav ul li {
    width: 100%;
    text-align: center;
  }

  table, th, td {
    font-size: 12px;
  }

  .card {
    font-size: 14px;
    padding: 8px;
  }
}
@media (max-width: 600px) {
  .card-body button {
    display: block;
    width: 100%;
    margin-bottom: 6px;
  }
}

    </style>
</head>
<body>
<!-- Men√∫ de navegaci√≥n -->
  <script>
  const claveCorrecta = "Chapi2025";
  const claveGuardada = sessionStorage.getItem("clavePrestamos");

  if (claveGuardada !== claveCorrecta) {
    const intento = prompt("üîê Ingresa la contrase√±a de acceso:");
    if (intento === claveCorrecta) {
      sessionStorage.setItem("clavePrestamos", claveCorrecta);
    } else {
      alert("Contrase√±a incorrecta.");
      window.location.href = "https://google.com";
    }
  }
</script>
    <nav>
        <ul>
            <li><a href="index.html" onclick="cargarSeccion('gestion')">Gesti√≥n de pr√©stamos</a></li>
            <li><a href="activos.html" onclick="cargarSeccion('activos')">Pr√©stamos activos</a></li>
            <li><a href="historial.html" onclick="cargarSeccion('historial')">Historial</a></li>
            <li><a href="estadisticas.html" onclick="cargarSeccion('estadisticas')">Estad√≠sticas</a></li>
        </ul>
    </nav>
    <div class="container">
        <h2>Historial de Pr√©stamos</h2>
        

        <!-- Campo de b√∫squeda y filtros -->
        <input type="text" id="busqueda" placeholder="Buscar por nombre, documento o fecha" onkeyup="filtrarHistorial()">
        <button onclick="exportarHistorial()">Exportar a Excel</button>

        <!-- Tabla de historial -->
        <table>
            <thead>
                <tr>
		    <th>Fecha</th>
                    <th>Nombre</th>
                    <th>Documento</th>
                    <th>Tipo de Usuario</th>
                    <th>Facultad</th>
                    <th>Sal√≥n</th>
                    <th>Hora Entrega</th>
                    <th>Hora Devoluci√≥n</th>
                    <th>Equipos</th>
                    <th>Horas Netas</th>
                </tr>
            </thead>
            <tbody id="historialPrestamos">
            </tbody>
        </table>
<br>
<br>
<br>
<button onclick="borrarHistorialFirestore()" style="background-color: #ff4444; color: white;">
    Borrar Historial y Estad√≠sticas
  </button>


    </div>

 <script>

/* Funci√≥n robusta para horas (soporta AM/PM y 24h) */
function calcularHorasNetas(horaEntrega, horaDevolucion) {
  if (!horaEntrega || !horaDevolucion) return 0;

  // Convierte a formato 24h aunque tenga AM o PM
  function convertirAHoras(horaStr) {
    if (!horaStr) return null;
    let h = 0, m = 0;
    let match = horaStr.match(/(\d{1,2}):(\d{2})\s*(AM|PM|A\.M\.|P\.M\.|am|pm)?/i);
    if (!match) return null;
    h = parseInt(match[1]);
    m = parseInt(match[2]);
    const ampm = (match[3] || "").toUpperCase();

    if (ampm.startsWith("P") && h < 12) h += 12;
    if (ampm.startsWith("A") && h === 12) h = 0;
    return h * 60 + m; // total minutos desde medianoche
  }

  const t1 = convertirAHoras(String(horaEntrega).trim());
  const t2 = convertirAHoras(String(horaDevolucion).trim());
  if (t1 === null || t2 === null) return 0;

  let minutos = t2 - t1;
  if (minutos < 0) minutos += 24 * 60; // cruza medianoche
  return Number((minutos / 60).toFixed(2));
}

/* Filtrar filas (usa la tabla ya renderizada) */
window.filtrarHistorial = function () {
  let filtro = document.getElementById("busqueda").value.toLowerCase();
  let filas = document.querySelectorAll("#historialPrestamos tr");
  filas.forEach(fila => {
    let textoFila = fila.innerText.toLowerCase();
    fila.style.display = textoFila.includes(filtro) ? "" : "none";
  });
};

/* Exportar usando los datos que carg√≥ el m√≥dulo (window.historialFire) */
window.exportarHistorial = function () {
  const historial = window.historialFire || [];
  if (historial.length === 0) {
    alert("No hay datos para exportar.");
    return;
  }

  const rows = [[
    "Fecha", "Nombre", "Documento", "Tipo de Usuario", "Facultad",
    "Salones", "Hora Entrega", "Hora Devoluci√≥n", "Equipos", "Horas Netas"
  ]];

  historial.forEach(p => {
    const salones = Array.isArray(p.salones)
      ? p.salones.map(s => s.nombre || "Sin nombre").join(" / ")
      : (p.salon || "N/A");

    const horaEntrega = Array.isArray(p.salones)
      ? p.salones.map(s => s.horaEntrega || "?").join(", ")
      : (p.horaEntrega || "N/A");

    const horaDevolucion = Array.isArray(p.salones)
      ? p.salones.map(s => s.horaDevolucion || "?").join(", ")
      : (p.horaDevolucion || "N/A");

    const equipos = Array.isArray(p.equipos)
      ? p.equipos.map(e => {
          if (typeof e === "string") return e;
          const nombre = e?.nombre || e?.equipo || "Desconocido";
          const cantidad = e?.cantidad || 1;
          return `${nombre} (x${cantidad})`;
        }).join(" - ")
      : "N/A";

    // Sumar horas netas de todos los salones (si existen)
    let horasNetas = 0;
    if (Array.isArray(p.salones) && p.salones.length > 0) {
      p.salones.forEach(s => {
        const h = calcularHorasNetas(s.horaEntrega, s.horaDevolucion);
        if (!isNaN(h) && h > 0) horasNetas += h;
      });
    } else {
      const h = calcularHorasNetas(p.horaEntrega, p.horaDevolucion);
      if (!isNaN(h) && h > 0) horasNetas = h;
    }

    rows.push([
      p.fecha || "N/A",
      p.nombre || "N/A",
      p.documento || "N/A",
      p.tipoUsuario || "N/A",
      p.facultad || "N/A",
      salones,
      horaEntrega,
      horaDevolucion,
      equipos,
      Number(horasNetas || 0).toFixed(2)
    ]);
  });

  const ws = XLSX.utils.aoa_to_sheet(rows);
  ws["!cols"] = [
    { wch: 12 }, { wch: 40 }, { wch: 15 }, { wch: 18 }, { wch: 35 },
    { wch: 25 }, { wch: 20 }, { wch: 20 }, { wch: 40 }, { wch: 12 }
  ];
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Historial");
  XLSX.writeFile(wb, "Historial_Prestamos.xlsx");
  alert("‚úÖ Historial exportado correctamente.");
};

/* NO llamamos aqu√≠ a cargarHistorial() ‚Äî el m√≥dulo ya asign√≥ window.onload = cargarHistorial */
</script>

    <b> ¬© Juan Ladino - 2025 </b>
</body>
</html>