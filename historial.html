<!DOCTYPE html>
<html lang="es">
<head>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<link rel="icon" type="image/png" href="favicon.ico">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historial de Pr√©stamos</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import {
          getFirestore,
          getDocs,
          collection, 
          addDoc
        } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
        
        // Configuraci√≥n Firebase
        const firebaseConfig = {
    apiKey: "AIzaSyB1Kj1aza4ynCCLMKObO8_zREB_dnxxL4s",
    authDomain: "prestamos-pregrado.firebaseapp.com",
    projectId: "prestamos-pregrado",
    storageBucket: "prestamos-pregrado.firebasestorage.app",
    messagingSenderId: "760036803136",
  appId: "1:760036803136:web:60ebba863d673c49e515a5"
  };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        import { deleteDoc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

window.borrarHistorialFirestore = async function () {
  if (!confirm("¬øEst√°s seguro de que deseas borrar TODO el historial de Firestore? Esta acci√≥n no se puede deshacer.")) return;

  const snapshot = await getDocs(collection(db, "historial"));
  let borrados = 0;

  for (const docu of snapshot.docs) {
    await deleteDoc(docu.ref);
    borrados++;
  }

  alert(`Historial borrado: ${borrados} registros eliminados.`);
  cargarHistorial();
};



       


        // Leer historial desde Firestore
async function cargarHistorial() {
  const tabla = document.getElementById("historialPrestamos");
  tabla.innerHTML = "";

  const snapshot = await getDocs(collection(db, "historial"));
  const prestamos = [];

  snapshot.forEach(doc => prestamos.push(doc.data()));
  prestamos.reverse();

  prestamos.forEach(p => {
    // üß© Compatibilidad con formato nuevo
    const salones = Array.isArray(p.salones)
      ? p.salones.map(s => s.nombre || "Sin nombre").join(" / ")
      : (p.salon || "N/A");

    const horaEntrega = Array.isArray(p.salones)
      ? p.salones.map(s => s.horaEntrega || "?").join(", ")
      : (p.horaEntrega || "N/A");

    const horaDevolucion = Array.isArray(p.salones)
      ? p.salones.map(s => s.horaDevolucion || "?").join(", ")
      : (p.horaDevolucion || "N/A");

    // üíª Equipos
    const equipos = Array.isArray(p.equipos)
      ? p.equipos.map(e => {
          if (typeof e === "string") return e;
          const nombre = e?.nombre || e?.equipo || "Desconocido";
          const cantidad = e?.cantidad || 1;
          return `${nombre} (x${cantidad})`;
        }).join(" - ")
      : "N/A";

// üïí Sumar horas netas de todos los salones
let horasNetas = 0;
if (Array.isArray(p.salones)) {
  p.salones.forEach(s => {
    const h = calcularHorasNetas(s.horaEntrega, s.horaDevolucion);
    if (!isNaN(h) && h > 0) horasNetas += h;
  });
} else {
  const h = calcularHorasNetas(p.horaEntrega, p.horaDevolucion);
  if (!isNaN(h) && h > 0) horasNetas += h;
}

const row = `
  <tr>
    <td>${p.fecha || "N/A"}</td>
    <td>${p.nombre || "N/A"}</td>
    <td>${p.documento || "N/A"}</td>
    <td>${p.tipoUsuario || "N/A"}</td>
    <td>${p.facultad || "N/A"}</td>
    <td>${Array.isArray(p.salones) ? p.salones.map(s => s.nombre || "Sin nombre").join(" / ") : (p.salon || "N/A")}</td>
    <td>${Array.isArray(p.salones) ? p.salones.map(s => s.horaEntrega || "?").join(", ") : (p.horaEntrega || "N/A")}</td>
    <td>${Array.isArray(p.salones) ? p.salones.map(s => s.horaDevolucion || "?").join(", ") : (p.horaDevolucion || "N/A")}</td>
    <td>${Array.isArray(p.equipos) ? p.equipos.map(e => (typeof e === "string" ? e : (e.nombre || e.equipo || "Desconocido")) + (e.cantidad ? ` (x${e.cantidad})` : "")).join(" - ") : "N/A"}</td>
    <td>${Number(horasNetas || 0).toFixed(2)}</td>
  </tr>`;
tabla.innerHTML += row;

  });

  window.historialFire = prestamos;
}

        
        window.filtrarHistorial = function () {
          let filtro = document.getElementById("busqueda").value.toLowerCase();
          let filas = document.querySelectorAll("#historialPrestamos tr");
          filas.forEach(fila => {
            let textoFila = fila.innerText.toLowerCase();
            fila.style.display = textoFila.includes(filtro) ? "" : "none";
          });
        };
        

//EXPORTAR HISTORIAL

window.exportarHistorial = function () {
  const historial = window.historialFire || [];
  if (historial.length === 0) {
    alert("No hay datos para exportar.");
    return;
  }

  const rows = [[
    "Fecha", "Nombre", "Documento", "Tipo de Usuario", "Facultad",
    "Salones", "Hora Entrega", "Hora Devoluci√≥n", "Equipos", "Horas Netas"
  ]];

  historial.forEach(p => {
    const salones = Array.isArray(p.salones)
      ? p.salones.map(s => s.nombre || "Sin nombre").join(" / ")
      : (p.salon || "N/A");

    const horaEntrega = Array.isArray(p.salones)
      ? p.salones.map(s => s.horaEntrega || "?").join(", ")
      : (p.horaEntrega || "N/A");

    const horaDevolucion = Array.isArray(p.salones)
      ? p.salones.map(s => s.horaDevolucion || "?").join(", ")
      : (p.horaDevolucion || "N/A");

    const equipos = Array.isArray(p.equipos)
      ? p.equipos.map(e => {
          if (typeof e === "string") return e;
          const nombre = e?.nombre || e?.equipo || "Desconocido";
          const cantidad = e?.cantidad || 1;
          return `${nombre} (x${cantidad})`;
        }).join(" - ")
      : "N/A";

    // üïí Sumar horas netas de todos los salones
    let horasNetas = 0;
    if (Array.isArray(p.salones)) {
      p.salones.forEach(s => {
        const h = calcularHorasNetas(s.horaEntrega, s.horaDevolucion);
        if (!isNaN(h)) horasNetas += h;
      });
    } else {
      const h = calcularHorasNetas(p.horaEntrega, p.horaDevolucion);
      if (!isNaN(h)) horasNetas += h;
    }

    rows.push([
      p.fecha || "N/A",
      p.nombre || "N/A",
      p.documento || "N/A",
      p.tipoUsuario || "N/A",
      p.facultad || "N/A",
      salones,
      horaEntrega,
      horaDevolucion,
      equipos,
      Number(horasNetas || 0).toFixed(2)
    ]);
  });

  const ws = XLSX.utils.aoa_to_sheet(rows);

  const headerCells = ["A1","B1","C1","D1","E1","F1","G1","H1","I1","J1"];
  headerCells.forEach(cell => {
    if (ws[cell]) {
      ws[cell].s = {
        font: { name: "Calibri", sz: 12, bold: true, color: { rgb: "FFFFFF" } },
        fill: { patternType: "solid", fgColor: { rgb: "007BFF" } },
        alignment: { horizontal: "center", vertical: "center" }
      };
    }
  });

  ws["!cols"] = [
    { wch: 12 }, { wch: 40 }, { wch: 15 }, { wch: 18 }, { wch: 35 },
    { wch: 25 }, { wch: 20 }, { wch: 20 }, { wch: 40 }, { wch: 12 }
  ];

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Historial");
  XLSX.writeFile(wb, "Historial_Prestamos.xlsx");

  alert("‚úÖ Historial exportado correctamente.");
};




        window.onload = cargarHistorial;
        </script>
    <style>
        table {
  width: 100%;
  overflow-x: auto;
  display: block;
}
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
        }
       .container {
            max-width: 100%;
            margin: auto;
            background: white;
            width: 100%;
            box-sizing: border-box;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
        }
        input {
            margin: 5px 0;
            padding: 10px;
            width: 98%;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
	select {
            margin: 5px 0;
            padding: 10px;
            width: 94%;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
	button {
            margin: 5px 0;
            padding: 10px;
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }
        th {
            background: #007BFF;
            color: white;
        }
/* Estilos para el men√∫ */
        nav {
            background-color: #007BFF;
            padding: 10px;
            color: white;
        }
        nav ul {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: space-around;
        }
        nav ul li {
            display: inline;
        }
        nav ul li a {
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            display: block;
        }
        nav ul li a:hover {
            background-color: #0056b3;
        }
        @media (max-width: 600px) {
  body {
    font-size: 14px;
  }

  nav ul {
    flex-direction: column;
    align-items: center;
  }

  nav ul li {
    width: 100%;
    text-align: center;
  }

  table, th, td {
    font-size: 12px;
  }

  .card {
    font-size: 14px;
    padding: 8px;
  }
}
@media (max-width: 600px) {
  .card-body button {
    display: block;
    width: 100%;
    margin-bottom: 6px;
  }
}

    </style>
</head>
<body>
<!-- Men√∫ de navegaci√≥n -->
  <script>
  const claveCorrecta = "Chapi2025";
  const claveGuardada = sessionStorage.getItem("clavePrestamos");

  if (claveGuardada !== claveCorrecta) {
    const intento = prompt("üîê Ingresa la contrase√±a de acceso:");
    if (intento === claveCorrecta) {
      sessionStorage.setItem("clavePrestamos", claveCorrecta);
    } else {
      alert("Contrase√±a incorrecta.");
      window.location.href = "https://google.com";
    }
  }
</script>
    <nav>
        <ul>
            <li><a href="index.html" onclick="cargarSeccion('gestion')">Gesti√≥n de pr√©stamos</a></li>
            <li><a href="activos.html" onclick="cargarSeccion('activos')">Pr√©stamos activos</a></li>
            <li><a href="historial.html" onclick="cargarSeccion('historial')">Historial</a></li>
            <li><a href="estadisticas.html" onclick="cargarSeccion('estadisticas')">Estad√≠sticas</a></li>
        </ul>
    </nav>
    <div class="container">
        <h2>Historial de Pr√©stamos</h2>
        

        <!-- Campo de b√∫squeda y filtros -->
        <input type="text" id="busqueda" placeholder="Buscar por nombre, documento o fecha" onkeyup="filtrarHistorial()">
        <button onclick="exportarHistorial()">Exportar a Excel</button>

        <!-- Tabla de historial -->
        <table>
            <thead>
                <tr>
		    <th>Fecha</th>
                    <th>Nombre</th>
                    <th>Documento</th>
                    <th>Tipo de Usuario</th>
                    <th>Facultad</th>
                    <th>Sal√≥n</th>
                    <th>Hora Entrega</th>
                    <th>Hora Devoluci√≥n</th>
                    <th>Equipos</th>
                    <th>Horas Netas</th>
                </tr>
            </thead>
            <tbody id="historialPrestamos">
            </tbody>
        </table>
<br>
<br>
<br>
<button onclick="borrarHistorialFirestore()" style="background-color: #ff4444; color: white;">
    Borrar Historial y Estad√≠sticas
  </button>


    </div>

    <script>




//calcular horas netas 

function calcularHorasNetas(horaEntrega, horaDevolucion) {
  if (!horaEntrega || !horaDevolucion) return 0;
  const [h1, m1] = horaEntrega.split(":").map(Number);
  const [h2, m2] = horaDevolucion.split(":").map(Number);
  if (isNaN(h1) || isNaN(m1) || isNaN(h2) || isNaN(m2)) return 0;
  let minutos = (h2 * 60 + m2) - (h1 * 60 + m1);
  if (minutos < 0) minutos += 24 * 60; // si pas√≥ medianoche
  return Number((minutos / 60).toFixed(2));
}



	// Funci√≥n para borrar el historial
function borrarHistorial() {
    if (confirm("¬øEst√°s seguro de que deseas borrar todo el historial? Esta acci√≥n no se puede deshacer.")) {
        localStorage.removeItem("historial"); // Elimina el historial del localStorage
        cargarHistorial(); // Recarga la tabla para reflejar que no hay datos
        alert("El historial ha sido borrado correctamente.");
    }
}



        function cargarHistorial() {
    let historial = JSON.parse(localStorage.getItem("historial")) || [];
    let historialTabla = document.getElementById("historialPrestamos");
    historialTabla.innerHTML = "";

    // Invertir el orden del historial
    // historial.reverse().forEach(p => {
    //     let row = `<tr>
   //          <td>${p.fecha || 'N/A'}</td> <!-- Nueva columna -->
   //          <td>${p.nombre}</td>
   //          <td>${p.documento}</td>
    //         <td>${p.tipoUsuario}</td>
    //         <td>${p.facultad}</td>
    //         <td>${p.salon}</td>
    //         <td>${p.horaEntrega}</td>
    //         <td>${p.horaDevolucion}</td>
    //         <td>${p.equipos.join(" - ")}</td>
    //         <td>${calcularHorasNetas(p.horaEntrega, p.horaDevolucion)}</td>
    //     </tr>`;
    //     historialTabla.innerHTML += row;
    // });
}

        // Funci√≥n para filtrar el historial
        function filtrarHistorial() {
            let filtro = document.getElementById("busqueda").value.toLowerCase();
            let filas = document.querySelectorAll("#historialPrestamos tr");
            filas.forEach(fila => {
                let textoFila = fila.innerText.toLowerCase();
                fila.style.display = textoFila.includes(filtro) ? "" : "none";
            });
        }

        function exportarHistorial() {
    let historial = JSON.parse(localStorage.getItem("historial")) || [];
    if (historial.length === 0) {
        alert("No hay datos en el historial para exportar.");
        return;
    }

    // Encabezado con la nueva columna de Fecha
    let csvContent = "Fecha,Nombre,Documento,Tipo de Usuario,Facultad,Sal√≥n,Hora Entrega,Hora Devoluci√≥n,Equipos,Horas Netas\n";

    historial.forEach(p => {
        let equipos = p.equipos ? p.equipos.join(" - ") : "";
        let horasNetas = calcularHorasNetas(p.horaEntrega, p.horaDevolucion);
        // Agregar la fecha al CSV
        csvContent += `"${p.fecha || 'N/A'}","${p.nombre}","${p.documento}","${p.tipoUsuario}","${p.facultad}","${p.salon}","${p.horaEntrega}","${p.horaDevolucion}","${equipos}","${horasNetas}"\n`;
    });

    let blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    let link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "Historial_Prestamos.csv";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

        // Cargar el historial al abrir la p√°gina
        document.addEventListener("DOMContentLoaded", function () {
            cargarHistorial();
        });
    </script>
    <b> ¬© Juan Ladino - 2025 </b>
</body>
</html>