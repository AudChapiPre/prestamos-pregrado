<!DOCTYPE html>
<html lang="es">
<head>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<link rel="icon" type="image/png" href="favicon.ico">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historial de Pr칠stamos</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import {
          getFirestore,
          getDocs,
          collection, 
          addDoc
        } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
        
        // Configuraci칩n Firebase
        const firebaseConfig = {
    apiKey: "AIzaSyB1Kj1aza4ynCCLMKObO8_zREB_dnxxL4s",
    authDomain: "prestamos-pregrado.firebaseapp.com",
    projectId: "prestamos-pregrado",
    storageBucket: "prestamos-pregrado.firebasestorage.app",
    messagingSenderId: "760036803136",
  appId: "1:760036803136:web:60ebba863d673c49e515a5"
  };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        import { deleteDoc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

window.borrarHistorialFirestore = async function () {
  if (!confirm("쮼st치s seguro de que deseas borrar TODO el historial de Firestore? Esta acci칩n no se puede deshacer.")) return;

  const snapshot = await getDocs(collection(db, "historial"));
  let borrados = 0;

  for (const docu of snapshot.docs) {
    await deleteDoc(docu.ref);
    borrados++;
  }

  alert(`Historial borrado: ${borrados} registros eliminados.`);
  cargarHistorial();
};



        
        // Leer historial desde Firestore
        async function cargarHistorial() {
          const tabla = document.getElementById("historialPrestamos");
          tabla.innerHTML = "";
        
          const snapshot = await getDocs(collection(db, "historial"));
          const prestamos = [];
        
          snapshot.forEach(doc => {
            const p = doc.data();
            prestamos.push(p);
          });
        
          // Orden inverso (del m치s reciente al m치s antiguo)
          prestamos.reverse().forEach(p => {
            const row = `<tr>
              <td>${p.fecha || "N/A"}</td>
              <td>${p.nombre}</td>
              <td>${p.documento}</td>
              <td>${p.tipoUsuario}</td>
              <td>${p.facultad}</td>
              <td>${p.salon}</td>
              <td>${p.horaEntrega}</td>
              <td>${p.horaDevolucion}</td>
              <td>${(p.equipos || []).join(" - ")}</td>
              <td>${calcularHorasNetas(p.horaEntrega, p.horaDevolucion)}</td>
            </tr>`;
            tabla.innerHTML += row;
          });
        
          // Guardar copia local en memoria para exportaci칩n
          window.historialFire = prestamos;
        }
        
        window.filtrarHistorial = function () {
          let filtro = document.getElementById("busqueda").value.toLowerCase();
          let filas = document.querySelectorAll("#historialPrestamos tr");
          filas.forEach(fila => {
            let textoFila = fila.innerText.toLowerCase();
            fila.style.display = textoFila.includes(filtro) ? "" : "none";
          });
        };
        

//EXPORTAR HISTORIAL

      window.exportarHistorial = function () {
    const historial = window.historialFire || [];
    if (historial.length === 0) {
        alert("No hay datos para exportar.");
        return;
    }

    // Construir datos (encabezados + filas)
    const rows = [
        ["Fecha", "Nombre", "Documento", "Tipo de Usuario", "Facultad", "Sal칩n", "Hora Entrega", "Hora Devoluci칩n", "Equipos", "Horas Netas"],
        ...historial.map(p => [
            p.fecha || "N/A",
            p.nombre,
            p.documento,
            p.tipoUsuario,
            p.facultad,
            p.salon,
            p.horaEntrega,
            p.horaDevolucion,
            p.equipos ? p.equipos.join(" - ") : "",
            calcularHorasNetas(p.horaEntrega, p.horaDevolucion)
        ])
    ];

    // Crear hoja desde array
    const ws = XLSX.utils.aoa_to_sheet(rows);

    // Estilo b치sico para encabezados (azul con letras blancas y centrados)
    const headerCells = ["A1","B1","C1","D1","E1","F1","G1","H1","I1","J1"];
    headerCells.forEach(cell => {
    if(ws[cell]) {
        ws[cell].s = {
            font: { name: "Calibri", sz: 12, bold: true, color: { rgb: "FFFFFF" } },
            fill: { patternType: "solid", fgColor: { rgb: "007BFF" } },
            alignment: { horizontal: "center", vertical: "center" },
            border: {
              top:    { style: "thin", color: { rgb: "000000" } },
              bottom: { style: "thin", color: { rgb: "000000" } },
              left:   { style: "thin", color: { rgb: "000000" } },
              right:  { style: "thin", color: { rgb: "000000" } }
            }
        };
    }
});

    // Ajustar ancho de columnas autom치ticamente
    ws["!cols"] = [
        { wch: 12 },  // Fecha
        { wch: 50 },  // Nombre
        { wch: 15 },  // Documento
        { wch: 18 },  // Tipo de Usuario
        { wch: 50 },  // Facultad
        { wch: 12 },  // Sal칩n
        { wch: 12 },  // Hora Entrega
        { wch: 15 },  // Hora Devoluci칩n
        { wch: 50 },  // Equipos
        { wch: 12 }   // Horas Netas
    ];

    // Crear libro y exportar
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Historial");
    XLSX.writeFile(wb, "Historial_Prestamos.xlsx");
};



        window.onload = cargarHistorial;
        </script>
    <style>
        table {
  width: 100%;
  overflow-x: auto;
  display: block;
}
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
        }
       .container {
            max-width: 100%;
            margin: auto;
            background: white;
            width: 100%;
            box-sizing: border-box;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
        }
        input {
            margin: 5px 0;
            padding: 10px;
            width: 98%;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
	select {
            margin: 5px 0;
            padding: 10px;
            width: 94%;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
	button {
            margin: 5px 0;
            padding: 10px;
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }
        th {
            background: #007BFF;
            color: white;
        }
/* Estilos para el men칰 */
        nav {
            background-color: #007BFF;
            padding: 10px;
            color: white;
        }
        nav ul {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: space-around;
        }
        nav ul li {
            display: inline;
        }
        nav ul li a {
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            display: block;
        }
        nav ul li a:hover {
            background-color: #0056b3;
        }
        @media (max-width: 600px) {
  body {
    font-size: 14px;
  }

  nav ul {
    flex-direction: column;
    align-items: center;
  }

  nav ul li {
    width: 100%;
    text-align: center;
  }

  table, th, td {
    font-size: 12px;
  }

  .card {
    font-size: 14px;
    padding: 8px;
  }
}
@media (max-width: 600px) {
  .card-body button {
    display: block;
    width: 100%;
    margin-bottom: 6px;
  }
}

    </style>
</head>
<body>
<!-- Men칰 de navegaci칩n -->
  <script>
  const claveCorrecta = "Chapi2025";
  const claveGuardada = sessionStorage.getItem("clavePrestamos");

  if (claveGuardada !== claveCorrecta) {
    const intento = prompt("游댏 Ingresa la contrase침a de acceso:");
    if (intento === claveCorrecta) {
      sessionStorage.setItem("clavePrestamos", claveCorrecta);
    } else {
      alert("Contrase침a incorrecta.");
      window.location.href = "https://google.com";
    }
  }
</script>
    <nav>
        <ul>
            <li><a href="index.html" onclick="cargarSeccion('gestion')">Gesti칩n de pr칠stamos</a></li>
            <li><a href="activos.html" onclick="cargarSeccion('activos')">Pr칠stamos activos</a></li>
            <li><a href="historial.html" onclick="cargarSeccion('historial')">Historial</a></li>
            <li><a href="estadisticas.html" onclick="cargarSeccion('estadisticas')">Estad칤sticas</a></li>
        </ul>
    </nav>
    <div class="container">
        <h2>Historial de Pr칠stamos</h2>
        

        <!-- Campo de b칰squeda y filtros -->
        <input type="text" id="busqueda" placeholder="Buscar por nombre, documento o fecha" onkeyup="filtrarHistorial()">
        <button onclick="exportarHistorial()">Exportar a CSV</button>

        <!-- Tabla de historial -->
        <table>
            <thead>
                <tr>
		    <th>Fecha</th>
                    <th>Nombre</th>
                    <th>Documento</th>
                    <th>Tipo de Usuario</th>
                    <th>Facultad</th>
                    <th>Sal칩n</th>
                    <th>Hora Entrega</th>
                    <th>Hora Devoluci칩n</th>
                    <th>Equipos</th>
                    <th>Horas Netas</th>
                </tr>
            </thead>
            <tbody id="historialPrestamos">
            </tbody>
        </table>
<br>
<br>
<br>
<button onclick="borrarHistorialFirestore()" style="background-color: #ff4444; color: white;">
    Borrar Historial y Estad칤sticas
  </button>
  

    </div>

    <script>

function calcularHorasNetas(horaEntrega, horaDevolucion) {
  if (!horaEntrega || !horaDevolucion) return 0;

  let entrega = new Date(`1970-01-01T${horaEntrega}:00`);
  let devolucion = new Date(`1970-01-01T${horaDevolucion}:00`);
  let diferencia = devolucion - entrega;

  // Retornar solo si es v치lido
  return isNaN(diferencia) ? 0 : Math.max(0, diferencia / (1000 * 60 * 60));
}

	// Funci칩n para borrar el historial
function borrarHistorial() {
    if (confirm("쮼st치s seguro de que deseas borrar todo el historial? Esta acci칩n no se puede deshacer.")) {
        localStorage.removeItem("historial"); // Elimina el historial del localStorage
        cargarHistorial(); // Recarga la tabla para reflejar que no hay datos
        alert("El historial ha sido borrado correctamente.");
    }
}

        // Funci칩n para calcular horas netas en formato decimal
        function calcularHorasNetas(horaEntrega, horaDevolucion) {
            let entrega = new Date(`1970-01-01T${horaEntrega}:00`);
            let devolucion = new Date(`1970-01-01T${horaDevolucion}:00`);
            let diferencia = devolucion - entrega; // Diferencia en milisegundos
            return (diferencia / (1000 * 60 * 60)).toFixed(2); // Convertir a horas con 2 decimales
        }

        function cargarHistorial() {
    let historial = JSON.parse(localStorage.getItem("historial")) || [];
    let historialTabla = document.getElementById("historialPrestamos");
    historialTabla.innerHTML = "";

    // Invertir el orden del historial
    // historial.reverse().forEach(p => {
    //     let row = `<tr>
   //          <td>${p.fecha || 'N/A'}</td> <!-- Nueva columna -->
   //          <td>${p.nombre}</td>
   //          <td>${p.documento}</td>
    //         <td>${p.tipoUsuario}</td>
    //         <td>${p.facultad}</td>
    //         <td>${p.salon}</td>
    //         <td>${p.horaEntrega}</td>
    //         <td>${p.horaDevolucion}</td>
    //         <td>${p.equipos.join(" - ")}</td>
    //         <td>${calcularHorasNetas(p.horaEntrega, p.horaDevolucion)}</td>
    //     </tr>`;
    //     historialTabla.innerHTML += row;
    // });
}

        // Funci칩n para filtrar el historial
        function filtrarHistorial() {
            let filtro = document.getElementById("busqueda").value.toLowerCase();
            let filas = document.querySelectorAll("#historialPrestamos tr");
            filas.forEach(fila => {
                let textoFila = fila.innerText.toLowerCase();
                fila.style.display = textoFila.includes(filtro) ? "" : "none";
            });
        }

        function exportarHistorial() {
    let historial = JSON.parse(localStorage.getItem("historial")) || [];
    if (historial.length === 0) {
        alert("No hay datos en el historial para exportar.");
        return;
    }

    // Encabezado con la nueva columna de Fecha
    let csvContent = "Fecha,Nombre,Documento,Tipo de Usuario,Facultad,Sal칩n,Hora Entrega,Hora Devoluci칩n,Equipos,Horas Netas\n";

    historial.forEach(p => {
        let equipos = p.equipos ? p.equipos.join(" - ") : "";
        let horasNetas = calcularHorasNetas(p.horaEntrega, p.horaDevolucion);
        // Agregar la fecha al CSV
        csvContent += `"${p.fecha || 'N/A'}","${p.nombre}","${p.documento}","${p.tipoUsuario}","${p.facultad}","${p.salon}","${p.horaEntrega}","${p.horaDevolucion}","${equipos}","${horasNetas}"\n`;
    });

    let blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    let link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "Historial_Prestamos.csv";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

        // Cargar el historial al abrir la p치gina
        document.addEventListener("DOMContentLoaded", function () {
            cargarHistorial();
        });
    </script>
    <b> 춸 Juan Ladino - 2025 </b>
</body>
</html>