<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="icon" type="image/png" href="favicon.ico">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pr√©stamos Activos</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import {
          getFirestore, collection, getDocs, getDoc, deleteDoc, setDoc, doc, addDoc
        } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
    
        const firebaseConfig = {
          apiKey: "AIzaSyC7llIg5wLu8P_5WBbjg4GW3orZZ1w8_vE",
          authDomain: "prestamos-1efef.firebaseapp.com",
          projectId: "prestamos-1efef",
          storageBucket: "prestamos-1efef.firebasestorage.app",
          messagingSenderId: "977813237082",
          appId: "1:977813237082:web:576287c13c305db3811763"
        };
    
        const app = initializeApp(firebaseConfig);
        const db = getFirestore();
        
        async function debugLeerColeccionesPosibles() {
  const nombres = ["prestamos", "Prestamos", "respaldo_prestamos", "activos", "pr√©stamos"];

  for (const nombre of nombres) {
    try {
      const ref = collection(db, nombre);
      const snapshot = await getDocs(ref);
      console.log(`üîé Colecci√≥n "${nombre}" tiene ${snapshot.size} documento(s):`);
      snapshot.forEach(doc => console.log("üìÑ", doc.id, doc.data()));
    } catch (error) {
      console.error("‚ùå Error al leer colecci√≥n:", nombre, error);
    }
  }
}

debugLeerColeccionesPosibles();



        async function mostrarPrestamosActivos() {
      const listaPrestamos = document.getElementById("listaPrestamos");
      listaPrestamos.innerHTML = "";

      try {
        const snapshot = await getDocs(collection(db, "prestamos"));
        console.log("‚úÖ Documentos encontrados:", snapshot.size);

        snapshot.forEach(docu => {
          const prestamo = docu.data();
          console.log("üì¶ Pr√©stamo:", docu.id, prestamo);

          if (prestamo.devuelto) return; // ‚ùå Ignorar si ya fue devuelto

          const card = document.createElement("div");
          card.className = "card prestamo-activo";

          card.innerHTML = `
            <div class="card-header">
              <span>${prestamo.nombre || ""} - ${prestamo.documento || ""}</span>
              <span>En pr√©stamo</span>
            </div>
            <div class="card-body">
              <p><strong>Tipo de Usuario:</strong> ${prestamo.tipoUsuario || ""}</p>
              <p><strong>Facultad:</strong> ${prestamo.facultad || ""}</p>
              <p><strong>Sal√≥n:</strong> ${prestamo.salon || ""}</p>
              <p><strong>Hora Entrega:</strong> ${prestamo.horaEntrega || ""}</p>
              <p><strong>Hora Devoluci√≥n:</strong> ${prestamo.horaDevolucion || ""}</p>
              <p><strong>Equipos:</strong> ${(prestamo.equipos || []).join(", ")}</p>
              
              <button class="btn-delete" onclick="eliminarPrestamo('${docu.id}')">Eliminar</button>
              <button onclick="editarPrestamo('${docu.id}')">Editar</button>


            </div>
          `;

          card.addEventListener("click", () => {
            card.classList.toggle("expanded");
          });

          listaPrestamos.appendChild(card);
        });
      } catch (error) {
        console.error("‚ùå Error cargando pr√©stamos:", error);
      }
    }

    window.eliminarPrestamo = async function(id) {
  try {
    // Obtener el pr√©stamo desde Firestore
    const ref = doc(db, "prestamos", id);
    const snap = await getDoc(ref);

    if (!snap.exists()) {
      alert("El pr√©stamo no existe.");
      return;
    }

    const prestamoEliminado = snap.data();

    // Calcular horas netas
    const horasNetas = parseFloat(calcularHorasNetas(prestamoEliminado.horaEntrega, prestamoEliminado.horaDevolucion));
    const horaEntrega = parseInt(prestamoEliminado.horaEntrega.split(":")[0]);
    const tipoUsuario = prestamoEliminado.tipoUsuario.toLowerCase();

    // Estad√≠sticas a√∫n en localStorage
    let estadisticas = JSON.parse(localStorage.getItem("estadisticas")) || {
      docentes: { ma√±ana: 0, tarde: 0, horasHDMI: 0, horasPortatiles: 0, horasAnchors: 0 },
      estudiantes: { ma√±ana: 0, tarde: 0, horasHDMI: 0, horasPortatiles: 0, horasAnchors: 0 },
      administrativos: { ma√±ana: 0, tarde: 0, horasHDMI: 0, horasPortatiles: 0, horasAnchors: 0 }
    };

    const grupo = estadisticas[tipoUsuario];
    if (grupo) {
      if (horaEntrega < 12) grupo.ma√±ana++;
      else grupo.tarde++;

      if (prestamoEliminado.equipos.includes("HDMI")) grupo.horasHDMI += horasNetas;
      if (prestamoEliminado.equipos.some(e => e.includes("PORTATIL"))) grupo.horasPortatiles += horasNetas;
      if (prestamoEliminado.equipos.includes("ANCHOR")) grupo.horasAnchors += horasNetas;
    }

    // Guardar estad√≠sticas en local
    localStorage.setItem("estadisticas", JSON.stringify(estadisticas));

    // Guardar en historial (en Firestore)
    await addDoc(collection(db, "historial"), prestamoEliminado);

    await deleteDoc(ref);
console.log("‚úÖ Pr√©stamo eliminado:", id);
console.log("üìà Estad√≠sticas actualizadas:", estadisticas);

// Refrescar lista
mostrarPrestamosActivos(); // ‚úÖ reemplazo correcto


  } catch (error) {
    console.error("‚ùå Error eliminando el pr√©stamo:", error);
  }
};

    window.editarPrestamo = async function(id) {
  try {
    const ref = doc(db, "prestamos", id);
    const snap = await getDoc(ref);

    if (!snap.exists()) {
      alert("El pr√©stamo no existe.");
      return;
    }

    const prestamo = snap.data();

    // Rellenar el formulario
    document.getElementById("documento").value = prestamo.documento || "";
    document.getElementById("nombre").value = prestamo.nombre || "";
    document.getElementById("tipoUsuario").value = prestamo.tipoUsuario || "";
    document.getElementById("facultad").value = prestamo.facultad || "";
    document.getElementById("salon").value = prestamo.salon || "";
    document.getElementById("horaEntrega").value = prestamo.horaEntrega || "";
    document.getElementById("horaDevolucion").value = prestamo.horaDevolucion || "";

    // Marcar los checkboxes de equipos
    const checkboxes = document.querySelectorAll("input[type='checkbox']");
    checkboxes.forEach(cb => {
      cb.checked = prestamo.equipos?.includes(cb.value) || false;
    });

    // Eliminar de Firestore para volver a guardar despu√©s con cambios
    await deleteDoc(ref);
    cargarDatos();

  } catch (error) {
    console.error("‚ùå Error al editar pr√©stamo:", error);
  }
};
    window.agregarAlHistorial = async function(prestamo) {
  const id = `${prestamo.documento}_${prestamo.fecha}`;
  try {
    await setDoc(doc(db, "historial", id), prestamo);
    console.log("‚úÖ Agregado al historial en Firestore:", id);
  } catch (error) {
    console.error("‚ùå Error al agregar al historial:", error);
  }
}
window.editarPrestamo = async function(id) {
  const ref = doc(db, "prestamos", id);
  const snap = await getDoc(ref);
  if (!snap.exists()) {
    alert("Pr√©stamo no encontrado.");
    return;
  }

  const prestamo = snap.data();
  let equiposDisponibles = ["HDMI", "CONTROL VB", "PORTATIL LENOVO", "PORTATIL DELL", "CARGADOR", "ANCHOR"];

  // Modal
  let modal = document.createElement("div");
  modal.innerHTML = `
    <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: white; padding: 20px; box-shadow: 0px 0px 10px rgba(0,0,0,0.3);
                border-radius: 10px; z-index: 1000; width: 300px;">
      <h3>Editar Pr√©stamo</h3>
      <label for="campo">Seleccione el campo a editar:</label>
      <select id="campo" onchange="mostrarOpcionesEdicion()">
          <option value="salon">Sal√≥n</option>
          <option value="horaEntrega">Hora de Entrega</option>
          <option value="horaDevolucion">Hora de Devoluci√≥n</option>
          <option value="equipos">Equipos</option>
      </select>
      <br><br>
      <div id="inputEdicion">
          <label for="nuevoValor">Nuevo Valor:</label>
          <input type="text" id="nuevoValor" placeholder="Ingrese el nuevo valor">
      </div>
      <div id="equiposEdicion" style="display: none;">
          <h4>Seleccione los equipos:</h4>
          <div class="checkbox-container" style="display: flex; flex-wrap: wrap; gap: 10px;">
              ${equiposDisponibles.map(eq => `
                  <label style="display: flex; align-items: center; gap: 5px; background: #e8e8e8; padding: 5px 10px; border-radius: 5px;">
                      <input type="checkbox" value="${eq}" ${prestamo.equipos.includes(eq) ? "checked" : ""}>
                      ${eq}
                  </label>`).join("")}
          </div>
          <input type="text" id="otrosEquipos" placeholder="Otros equipos">
      </div>
      <br>
      <button onclick="guardarEdicionFirestore('${id}')">Guardar</button>
      <button onclick="cerrarModal()">Cancelar</button>
    </div>
  `;

  modal.id = "modalEditar";
  document.body.appendChild(modal);
};

window.guardarEdicionFirestore = async function(id) {
  const campo = document.getElementById("campo").value;

  const ref = doc(db, "prestamos", id);
  const snap = await getDoc(ref);
  if (!snap.exists()) return;

  const prestamo = snap.data();

  if (campo === "equipos") {
    const checkboxes = document.querySelectorAll("#equiposEdicion input[type='checkbox']:checked");
    let seleccionados = Array.from(checkboxes).map(cb => cb.value);
    const otros = document.getElementById("otrosEquipos").value.trim();
    if (otros) seleccionados.push(otros);
    prestamo.equipos = seleccionados;
  } else {
    const nuevoValor = document.getElementById("nuevoValor").value.trim();
    if (!nuevoValor) {
      alert("El valor no puede estar vac√≠o.");
      return;
    }
    prestamo[campo] = nuevoValor;
  }

  await setDoc(ref, prestamo);
cerrarModal();
mostrarPrestamosActivos(); // ‚úÖ aqu√≠ s√≠ funciona

};

window.mostrarOpcionesEdicion = function() {
  let campoSeleccionado = document.getElementById("campo").value;
  let inputTexto = document.getElementById("inputEdicion");
  let equiposEdicion = document.getElementById("equiposEdicion");

  if (campoSeleccionado === "equipos") {
    inputTexto.style.display = "none";
    equiposEdicion.style.display = "block";
  } else {
    inputTexto.style.display = "block";
    equiposEdicion.style.display = "none";
  }
};

window.cerrarModal = function() {
  let modal = document.getElementById("modalEditar");
  if (modal) modal.remove();
};


    window.devolverPrestamo = async function(id) {
      const ref = doc(db, "prestamos", id);
      const snap = await getDoc(ref);
      if (snap.exists()) {
        await setDoc(doc(db, "historial", id), snap.data());
        await deleteDoc(ref);
        alert("Pr√©stamo devuelto.");
        mostrarPrestamosActivos();
      }
    }

    window.onload = mostrarPrestamosActivos;
      </script>
    <style>
      table {
  width: 100%;
  overflow-x: auto;
  display: block;
}
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
        }

        /* Estilos para pr√©stamos activos y devueltos */
        .prestamo-activo {
            background-color: rgba(255, 255, 0, 0.2); /* Amarillo con baja opacidad */
        }
        .prestamo-devuelto {
            background-color: rgba(0, 255, 0, 0.2); /* Verde con baja opacidad */
        }

        .container {
            max-width: 100%;
            margin: auto;
            background: white;
            width: 100%;
            box-sizing: border-box;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
        }
        input, select, button {
            margin: 5px 0;
            padding: 10px;
            width: 96%;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        fieldset {
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .checkbox-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .checkbox-container label {
            display: flex;
            align-items: center;
            gap: 5px;
            background: #e8e8e8;
            padding: 5px 10px;
            border-radius: 5px;
        }
        .card {
            background: white;
            border: 4px inset #007BFF;
            border-radius: 20px;
            padding: 10px;
            margin: 10px 0;
            cursor: pointer;
            transition: box-shadow 0.3s ease;
        }
        .card:hover {
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
        }
        .card.expanded {
            background: #f9f9f9;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-body {
            display: none;
            margin-top: 10px;
        }
        .card.expanded .card-body {
            display: block;
        }
        .btn-delete, .btn-edit, .btn-return {
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 5px;
        }
        .btn-delete {
            background: red;
        }
        .btn-return {
            background: green;
        }
        .btn-edit {
            background: orange;
        }
/* Estilos para el men√∫ */
        nav {
            background-color: #007BFF;
            padding: 10px;
            color: white;
        }
        nav ul {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: space-around;
        }
        nav ul li {
            display: inline;
        }
        nav ul li a {
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            display: block;
        }
        nav ul li a:hover {
            background-color: #0056b3;
        }
        @media (max-width: 600px) {
  body {
    font-size: 14px;
  }

  nav ul {
    flex-direction: column;
    align-items: center;
  }

  nav ul li {
    width: 100%;
    text-align: center;
  }

  table, th, td {
    font-size: 12px;
  }

  .card {
    font-size: 14px;
    padding: 8px;
  }
}
@media (max-width: 600px) {
  .card-body button {
    display: block;
    width: 100%;
    margin-bottom: 6px;
  }
}
    </style>
</head>
<body>
<!-- Men√∫ de navegaci√≥n -->
  <script>
  const claveCorrecta = "12345Post";
  const claveGuardada = sessionStorage.getItem("clavePrestamos");

  if (claveGuardada !== claveCorrecta) {
    const intento = prompt("üîê Ingresa la contrase√±a de acceso:");
    if (intento === claveCorrecta) {
      sessionStorage.setItem("clavePrestamos", claveCorrecta);
    } else {
      alert("Contrase√±a incorrecta.");
      window.location.href = "https://google.com";
    }
  }
</script>
    <nav>
        <ul>
            <li><a href="index.html" onclick="cargarSeccion('gestion')">Gesti√≥n de pr√©stamos</a></li>
            <li><a href="activos.html" onclick="cargarSeccion('activos')">Pr√©stamos activos</a></li>
            <li><a href="historial.html" onclick="cargarSeccion('historial')">Historial</a></li>
            <li><a href="estadisticas.html" onclick="cargarSeccion('estadisticas')">Estad√≠sticas</a></li>
        </ul>
    </nav>
    <div class="container">
        <h2>Gesti√≥n de Pr√©stamos</h2>
<h2>BUSQUEDA POR DOCUMENTO</H2>
	<input type="text" id="busqueda" placeholder="Buscar por nombre o documento" onkeyup="filtrarPrestamos()">

        <!-- Lista de pr√©stamos en tarjetas (arriba del formulario) -->
        <h2>Pr√©stamos Activos</h2>
        <div id="listaPrestamos"></div>
        
        
       
 

    </div>

    <script>
        
	// Funci√≥n para buscar usuario
function filtrarPrestamos() {
            let filtro = document.getElementById("busqueda").value.toLowerCase();
            let cards = document.querySelectorAll("#listaPrestamos .card");

            cards.forEach(card => {
                let textoCard = card.innerText.toLowerCase();
                if (textoCard.includes(filtro)) {
                    card.style.display = "";
                } else {
                    card.style.display = "none";
                }
            });
        }

        // Funci√≥n para calcular las horas netas de uso
        function calcularHorasNetas(horaEntrega, horaDevolucion) {
            let entrega = new Date(`1970-01-01T${horaEntrega}:00`);
            let devolucion = new Date(`1970-01-01T${horaDevolucion}:00`);
            let diferencia = devolucion - entrega; // Diferencia en milisegundos
            return Math.floor(diferencia / (1000 * 60 * 60)); // Convertir a horas
        }

        
    
        
        
       

      

    </script>
    <b> ¬© Juan Ladino - 2025 </b>
</body>
</html>