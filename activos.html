<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="icon" type="image/png" href="favicon.ico">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pr√©stamos Activos</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import {
          getFirestore, collection, getDocs, getDoc, deleteDoc, setDoc, doc, addDoc, updateDoc
        } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
    
        const firebaseConfig = {
    apiKey: "AIzaSyB1Kj1aza4ynCCLMKObO8_zREB_dnxxL4s",
    authDomain: "prestamos-pregrado.firebaseapp.com",
    projectId: "prestamos-pregrado",
    storageBucket: "prestamos-pregrado.firebasestorage.app",
    messagingSenderId: "760036803136",
  appId: "1:760036803136:web:60ebba863d673c49e515a5"
  };
    
        const app = initializeApp(firebaseConfig);
        const db = getFirestore();
        
        async function debugLeerColeccionesPosibles() {
  const nombres = ["prestamos", "Prestamos", "respaldo_prestamos", "activos", "pr√©stamos"];

  for (const nombre of nombres) {
    try {
      const ref = collection(db, nombre);
      const snapshot = await getDocs(ref);
      console.log(`üîé Colecci√≥n "${nombre}" tiene ${snapshot.size} documento(s):`);
      snapshot.forEach(doc => console.log("üìÑ", doc.id, doc.data()));
    } catch (error) {
      console.error("‚ùå Error al leer colecci√≥n:", nombre, error);
    }
  }
}

debugLeerColeccionesPosibles();



        async function mostrarPrestamosActivos() {
      const listaPrestamos = document.getElementById("listaPrestamos");
      listaPrestamos.innerHTML = "";

      try {
        const snapshot = await getDocs(collection(db, "prestamos"));
        console.log("‚úÖ Documentos encontrados:", snapshot.size);

        snapshot.forEach(docu => {
          const prestamo = docu.data();
          console.log("üì¶ Pr√©stamo:", docu.id, prestamo);

          if (prestamo.devuelto) return; // ‚ùå Ignorar si ya fue devuelto

          const card = document.createElement("div");
          card.className = "card prestamo-activo";

card.innerHTML = `
  <div class="card-header">
    <div>
      <h2 style="margin:0; font-size:1.5em;">
        ${
          Array.isArray(prestamo.salones) && prestamo.salones.length > 0
            ? prestamo.salones.map(s => s.nombre || "Sin nombre").join(" / ")
            : (prestamo.salon || "Sin sal√≥n")
        }
      </h2>
      <p style="margin:0; font-size:0.9em; color:#555;">
        ${
          Array.isArray(prestamo.salones)
            ? prestamo.salones.map(s => `${s.nombre || "sin"} (${s.horaEntrega || "?"} ‚Üí ${s.horaDevolucion || "?"})`).join(", ")
            : (prestamo.salon ? `${prestamo.salon} (${prestamo.horaEntrega || "?"} ‚Üí ${prestamo.horaDevolucion || "?"})` : "Sin horario")
        }
      </p>
      <p style="margin:0; font-size:0.9em; color:#555;">
        ${
          Array.isArray(prestamo.equipos)
            ? prestamo.equipos.map(e => {
                if (!e) return "";
                if (typeof e === "string") return e;
                const nombre = e.nombre || e.equipo || "Desconocido";
                const cantidad = e.cantidad || 1;
                return `${nombre} (x${cantidad})`;
              }).join(", ")
            : "Sin equipos"
        }
      </p>
    </div>
    <input type="checkbox" class="seleccion-prestamo" value="${docu.id}" style="transform:scale(1.5); margin-left:10px;">
  </div>
  <div class="card-body">
    <p><strong>Nombre:</strong> ${prestamo.nombre}</p>
    <p><strong>Documento:</strong> ${prestamo.documento}</p>
    <p><strong>Tipo de Usuario:</strong> ${prestamo.tipoUsuario}</p>
    <p><strong>Facultad:</strong> ${prestamo.facultad}</p>

    <button class="btn-edit" onclick="editarPrestamo('${docu.id}')">Editar</button>
    <button class="btn-delete" onclick="eliminarPrestamo('${docu.id}')">Eliminar</button>
  </div>
`;



          card.addEventListener("click", () => {
            card.classList.toggle("expanded");
          });

          listaPrestamos.appendChild(card);
        });
      } catch (error) {
        console.error("‚ùå Error cargando pr√©stamos:", error);
      }
    }

window.eliminarPrestamo = async function(id) {
  try {
    // Obtener el pr√©stamo desde Firestore
    const ref = doc(db, "prestamos", id);
    const snap = await getDoc(ref);

    if (!snap.exists()) {
      alert("El pr√©stamo no existe.");
      return;
    }

    const prestamoEliminado = snap.data();

    // üîπ Calcular horas netas (compatible con varios salones)
    let horasNetas = 0;
    let horaEntrega = 0;

    if (Array.isArray(prestamoEliminado.salones) && prestamoEliminado.salones.length > 0) {
      prestamoEliminado.salones.forEach(salon => {
        if (salon.horaEntrega && salon.horaDevolucion) {
          horasNetas += parseFloat(calcularHorasNetas(salon.horaEntrega, salon.horaDevolucion));
          horaEntrega = parseInt(salon.horaEntrega.split(":")[0]);
        }
      });
    } else if (prestamoEliminado.horaEntrega && prestamoEliminado.horaDevolucion) {
      horasNetas = parseFloat(calcularHorasNetas(prestamoEliminado.horaEntrega, prestamoEliminado.horaDevolucion));
      horaEntrega = parseInt(prestamoEliminado.horaEntrega.split(":")[0]);
    }

    const tipoUsuario = (prestamoEliminado.tipoUsuario || "").toLowerCase();

    // üîπ Guardar en historial (en Firestore)
    await addDoc(collection(db, "historial"), {
      ...prestamoEliminado,
      horasTotales: horasNetas,
      fechaFin: new Date().toISOString()
    });

    // üîπ Eliminar del activo
    await deleteDoc(ref);

    alert("‚úÖ Pr√©stamo enviado al historial y eliminado correctamente.");
    mostrarPrestamosActivos();

  } catch (error) {
    console.error("‚ùå Error eliminando el pr√©stamo:", error);
    alert("‚ùå Error eliminando el pr√©stamo: " + error.message);
  }
};

window.eliminarSeleccionados = async function() {
  const seleccionados = Array.from(document.querySelectorAll(".seleccion-prestamo:checked")).map(cb => cb.value);
  if (seleccionados.length === 0) {
    alert("No has seleccionado ning√∫n pr√©stamo.");
    return;
  }

  if (!confirm(`¬øSeguro que deseas eliminar ${seleccionados.length} pr√©stamo(s)? Ser√°n enviados al historial.`)) return;

  for (const id of seleccionados) {
    try {
      const ref = doc(db, "prestamos", id);
      const snap = await getDoc(ref);
      if (!snap.exists()) continue;

      const prestamoEliminado = snap.data();

      // üîπ Calcular horas netas (igual que en eliminarPrestamo)
      let horasNetas = 0;
      if (Array.isArray(prestamoEliminado.salones)) {
        prestamoEliminado.salones.forEach(salon => {
          if (salon.horaEntrega && salon.horaDevolucion) {
            horasNetas += parseFloat(calcularHorasNetas(salon.horaEntrega, salon.horaDevolucion));
          }
        });
      }

      // üîπ Guardar en historial
      await addDoc(collection(db, "historial"), {
        ...prestamoEliminado,
        horasTotales: horasNetas,
        fechaFin: new Date().toISOString()
      });

      // üîπ Eliminar del activo
      await deleteDoc(ref);

      console.log(`‚úÖ ${id} enviado al historial y eliminado`);
    } catch (error) {
      console.error(`‚ùå Error eliminando ${id}:`, error);
    }
  }

  alert(`‚úÖ ${seleccionados.length} pr√©stamo(s) enviados al historial y eliminados.`);
  mostrarPrestamosActivos();
};


window.marcarDevuelto = async function(id) {
  try {
    const ref = doc(db, "prestamos", id);
    const snap = await getDoc(ref);

    if (!snap.exists()) {
      alert("Pr√©stamo no encontrado.");
      return;
    }

    // Actualizamos solo el estado
    await updateDoc(ref, { devuelto: true });

    console.log(`‚úÖ Pr√©stamo ${id} marcado como devuelto`);
    mostrarPrestamosActivos(); // refresca la lista
  } catch (err) {
    console.error("Error al devolver:", err);
    alert("‚ùå No se pudo marcar como devuelto.");
  }
};




    window.agregarAlHistorial = async function(prestamo) {
  const id = `${prestamo.documento}_${prestamo.fecha}`;
  try {
    await setDoc(doc(db, "historial", id), prestamo);
    console.log("‚úÖ Agregado al historial en Firestore:", id);
  } catch (error) {
    console.error("‚ùå Error al agregar al historial:", error);
  }
}

window.editarPrestamo = async function(id) {
  const ref = doc(db, "prestamos", id);
  const snap = await getDoc(ref);
  if (!snap.exists()) {
    alert("Pr√©stamo no encontrado.");
    return;
  }

  const prestamo = snap.data();
  const equiposDisponibles = [
    "HDMI (TV)",
    "HDMI (ONESCREEN)",
    "CONTROL VB",
    "HDMI (VIDEOBEAM)",
    "PORTATIL LENOVO",
    "ANCHOR"
  ];

  const equiposSeleccionados = (prestamo.equipos || []).map(eq =>
    typeof eq === "string" ? eq : eq.nombre
  );

  // Crear modal limpio
  let modal = document.createElement("div");
  modal.innerHTML = `
    <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: white; padding: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.3);
                border-radius: 12px; z-index: 1000; width: 340px;">
      <h3 style="margin-top:0;">Editar pr√©stamo</h3>
      <label for="campo">Seleccione qu√© desea editar:</label>
      <select id="campo" onchange="mostrarOpcionesEdicion()" style="margin-top:8px;width:100%;">
        <option value="">-- Seleccione una opci√≥n --</option>
        <option value="salones">Salones y horarios</option>
        <option value="equipos">Equipos</option>
      </select>

      <div id="salonesEdicion" style="display:none; margin-top:15px;">
        <h4>Salones y horarios</h4>
        <div id="salones-container-editar">
          ${(prestamo.salones || []).map(s => `
            <div class="salon-item-editar" style="margin-bottom:8px;">
              <input type="text" class="salon" value="${s.nombre || ''}" placeholder="Sal√≥n">
              <input type="time" class="horaEntrega" value="${s.horaEntrega || ''}">
              <input type="time" class="horaDevolucion" value="${s.horaDevolucion || ''}">
            </div>
          `).join('')}
        </div>
        <button type="button" onclick="agregarSalonEditar()">+ A√±adir sal√≥n</button>
      </div>

      <div id="equiposEdicion" style="display:none; margin-top:15px;">
        <h4>Equipos</h4>
        <div style="display:flex;flex-wrap:wrap;gap:10px;">
          ${equiposDisponibles.map(eq => `
            <label style="display:flex;align-items:center;gap:5px;background:#eee;padding:5px;border-radius:5px;">
              <input type="checkbox" value="${eq}" ${equiposSeleccionados.includes(eq) ? "checked" : ""}>
              ${eq}
              <input type="number" min="1" value="${
                (prestamo.equipos.find(e => e.nombre === eq)?.cantidad) || 1
              }" style="width:45px;text-align:center;">
            </label>
          `).join("")}
        </div>
        <input type="text" id="otrosEquipos" placeholder="Otros equipos" style="margin-top:8px;width:100%;">
      </div>

      <div style="margin-top:15px;text-align:right;">
        <button onclick="guardarEdicionFirestore('${id}')">üíæ Guardar</button>
        <button onclick="cerrarModal()">Cancelar</button>
      </div>
    </div>
  `;

  modal.id = "modalEditar";
  document.body.appendChild(modal);
};

window.agregarSalonEditar = function() {
  const contenedor = document.getElementById("salones-container-editar");
  if (!contenedor) return;
  const nuevo = document.createElement("div");
  nuevo.className = "salon-item-editar";
  nuevo.style.marginBottom = "8px";
  nuevo.innerHTML = `
    <input type="text" class="salon" placeholder="Sal√≥n">
    <input type="time" class="horaEntrega">
    <input type="time" class="horaDevolucion">
  `;
  contenedor.appendChild(nuevo);
};

window.mostrarOpcionesEdicion = function() {
  const campo = document.getElementById("campo").value;
  document.getElementById("salonesEdicion").style.display = campo === "salones" ? "block" : "none";
  document.getElementById("equiposEdicion").style.display = campo === "equipos" ? "block" : "none";
};

window.guardarEdicionFirestore = async function(id) {
  const campo = document.getElementById("campo").value;
  if (!campo) {
    alert("Seleccione una opci√≥n para editar.");
    return;
  }

  const ref = doc(db, "prestamos", id);
  const snap = await getDoc(ref);
  if (!snap.exists()) return;
  const prestamo = snap.data();

  if (campo === "equipos") {
    const checkboxes = document.querySelectorAll("#equiposEdicion input[type='checkbox']:checked");
    const nuevosEquipos = [];
    checkboxes.forEach(cb => {
      const cantidad = parseInt(cb.nextElementSibling.value) || 1;
      nuevosEquipos.push({ nombre: cb.value, cantidad });
    });
    const otros = document.getElementById("otrosEquipos").value.trim();
    if (otros) nuevosEquipos.push({ nombre: otros, cantidad: 1 });
    prestamo.equipos = nuevosEquipos;
  }

  if (campo === "salones") {
    const salones = [];
    document.querySelectorAll("#salones-container-editar .salon-item-editar").forEach(div => {
      const nombre = div.querySelector(".salon").value.trim();
      const horaEntrega = div.querySelector(".horaEntrega").value;
      const horaDevolucion = div.querySelector(".horaDevolucion").value;
      if (nombre && horaEntrega && horaDevolucion) {
        salones.push({ nombre, horaEntrega, horaDevolucion });
      }
    });
    prestamo.salones = salones;
  }

  await setDoc(ref, prestamo);
  cerrarModal();
  mostrarPrestamosActivos();
};



window.cerrarModal = function() {
  let modal = document.getElementById("modalEditar");
  if (modal) modal.remove();
};


    window.devolverPrestamo = async function(id) {
      const ref = doc(db, "prestamos", id);
      const snap = await getDoc(ref);
      if (snap.exists()) {
        await setDoc(doc(db, "historial", id), snap.data());
        await deleteDoc(ref);
        alert("Pr√©stamo devuelto.");
        mostrarPrestamosActivos();
      }
    }

    window.onload = mostrarPrestamosActivos;
      </script>
    <style>
    


      table {
  width: 100%;
  overflow-x: auto;
  display: block;
}
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
        }

        /* Estilos para pr√©stamos activos y devueltos */
        .prestamo-activo {
            background-color: rgba(255, 255, 0, 0.2); /* Amarillo con baja opacidad */
        }
        .prestamo-devuelto {
            background-color: rgba(0, 255, 0, 0.2); /* Verde con baja opacidad */
        }

        .container {
            max-width: 100%;
            margin: auto;
            background: white;
            width: 100%;
            box-sizing: border-box;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
        }
        input, select, button {
            margin: 5px 0;
            padding: 10px;
            width: 96%;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        fieldset {
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .checkbox-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .checkbox-container label {
            display: flex;
            align-items: center;
            gap: 5px;
            background: #e8e8e8;
            padding: 5px 10px;
            border-radius: 5px;
        }
        .card {
            background: white;
            border: 4px inset #007BFF;
            border-radius: 20px;
            padding: 10px;
            margin: 10px 0;
            cursor: pointer;
            transition: box-shadow 0.3s ease;
        }
        .card:hover {
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
        }
        .card.expanded .card-body {
          max-height: 500px; /* suficiente para el contenido */
          opacity: 1;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
       .card-body {
          max-height: 0;
          overflow: hidden;
          transition: max-height 0.4s ease, opacity 0.4s ease;
          opacity: 0;
        }
        .card.expanded .card-body {
            display: block;
        }
        .btn-delete, .btn-edit, .btn-return {
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 5px;
        }
        .btn-delete {
            background: red;
        }
        .btn-return {
            background: green;
        }
        .btn-edit {
            background: orange;
        }
/* Estilos para el men√∫ */
        nav {
            background-color: #007BFF;
            padding: 10px;
            color: white;
        }
        nav ul {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: space-around;
        }
        nav ul li {
            display: inline;
        }
        nav ul li a {
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            display: block;
        }
        nav ul li a:hover {
            background-color: #0056b3;
        }
        @media (max-width: 600px) {
  body {
    font-size: 14px;
  }

  nav ul {
    flex-direction: column;
    align-items: center;
  }

  nav ul li {
    width: 100%;
    text-align: center;
  }

  table, th, td {
    font-size: 12px;
  }

  .card {
    font-size: 14px;
    padding: 8px;
  }
}
@media (max-width: 600px) {
  .card-body button {
    display: block;
    width: 100%;
    margin-bottom: 6px;
  }
}
    </style>
</head>
<body>
<!-- Men√∫ de navegaci√≥n -->
  <script>
  const claveCorrecta = "Chapi2025";
  const claveGuardada = sessionStorage.getItem("clavePrestamos");

  if (claveGuardada !== claveCorrecta) {
    const intento = prompt("üîê Ingresa la contrase√±a de acceso:");
    if (intento === claveCorrecta) {
      sessionStorage.setItem("clavePrestamos", claveCorrecta);
    } else {
      alert("Contrase√±a incorrecta.");
      window.location.href = "https://google.com";
    }
  }
</script>
    <nav>
        <ul>
            <li><a href="index.html" onclick="cargarSeccion('gestion')">Gesti√≥n de pr√©stamos</a></li>
            <li><a href="activos.html" onclick="cargarSeccion('activos')">Pr√©stamos activos</a></li>
            <li><a href="historial.html" onclick="cargarSeccion('historial')">Historial</a></li>
            <li><a href="estadisticas.html" onclick="cargarSeccion('estadisticas')">Estad√≠sticas</a></li>
        </ul>
    </nav>
    <div class="container">
        <h2>Gesti√≥n de Pr√©stamos</h2>
<h2>BUSQUEDA POR DOCUMENTO</H2>
	<input type="text" id="busqueda" placeholder="Buscar por nombre o documento" onkeyup="filtrarPrestamos()">

        <!-- Lista de pr√©stamos en tarjetas (arriba del formulario) -->
        <h2>Pr√©stamos Activos</h2>
        <div id="listaPrestamos"></div>
        <button onclick="eliminarSeleccionados()" style="background:red;color:white;padding:10px 15px;border:none;border-radius:5px;cursor:pointer;margin-bottom:10px;">
üóëÔ∏è Eliminar seleccionados
</button>

        
        
       
 

    </div>

    <script>
        
	// Funci√≥n para buscar usuario
function filtrarPrestamos() {
            let filtro = document.getElementById("busqueda").value.toLowerCase();
            let cards = document.querySelectorAll("#listaPrestamos .card");

            cards.forEach(card => {
                let textoCard = card.innerText.toLowerCase();
                if (textoCard.includes(filtro)) {
                    card.style.display = "";
                } else {
                    card.style.display = "none";
                }
            });
        }

        // Funci√≥n para calcular las horas netas de uso
        function calcularHorasNetas(horaEntrega, horaDevolucion) {
            let entrega = new Date(`1970-01-01T${horaEntrega}:00`);
            let devolucion = new Date(`1970-01-01T${horaDevolucion}:00`);
            let diferencia = devolucion - entrega; // Diferencia en milisegundos
            return Math.floor(diferencia / (1000 * 60 * 60)); // Convertir a horas
        }

        
    
        
        
       

      

    </script>
    <b> ¬© Juan Ladino - 2025 </b>
</body>
</html>